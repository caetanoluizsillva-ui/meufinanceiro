<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Meu Financeiro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #4f46e5;
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            --sidebar-width-collapsed: 70px;
            --sidebar-width-expanded: 240px;
            --transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --expense-color: #f43f5e;
            --income-color: #10b981;
            --notification-color: #f59e0b;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --gradient-danger: linear-gradient(135deg, #f43f5e 0%, #e11d48 100%);
            --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --glass-effect: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --shadow-glow: 0 0 20px rgba(79, 70, 229, 0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            min-height: 100vh;
            background-image: 
                radial-gradient(at 47% 33%, rgba(79, 70, 229, 0.1) 0, transparent 59%), 
                radial-gradient(at 82% 65%, rgba(16, 185, 129, 0.1) 0, transparent 55%);
            overflow-x: hidden;
        }

        /* --- AUTH SCREEN --- */
        #authScreen {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: var(--bg-body); 
            z-index: 3000;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        .auth-card {
            background: var(--bg-card); 
            padding: 40px; 
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3), var(--shadow-glow);
            width: 100%; 
            max-width: 400px; 
            text-align: center;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
        }
        .form-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; text-align: left; }
        .form-control { 
            padding: 12px 16px; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: 12px; 
            font-size: 1rem; 
            width: 100%; 
            background: rgba(15, 23, 42, 0.6);
            color: var(--text-main);
            transition: all 0.3s;
            font-size: 16px;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
        .password-wrapper {
            position: relative;
            width: 100%;
        }
        .password-wrapper .form-control {
            padding-right: 45px; /* Make space for the icon */
        }
        .password-toggle-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--text-sub);
            transition: color 0.2s;
        }
        .password-toggle-icon:hover {
            color: var(--primary-color);
        }
        .select-control { 
            padding: 12px 16px; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: 12px; 
            font-size: 1rem; 
            width: auto; 
            background: rgba(15, 23, 42, 0.6);
            color: var(--text-main);
            font-size: 16px;
        }
        .btn {
            padding: 12px 30px; 
            border: none; 
            border-radius: 12px; 
            font-weight: 600;
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            width: 100%;
            position: relative;
            overflow: hidden;
            min-height: 44px;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        .btn-primary { 
            background: var(--gradient-primary); 
            color: white; 
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.6);
        }
        .btn-ghost { 
            background: transparent; 
            color: var(--text-sub); 
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.85rem; 
            margin-top: 10px; 
        }
        .btn-ghost:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        .btn-sm { padding: 8px 16px; font-size: 0.9rem; width: auto; min-height: 36px; }
        .btn-danger { 
            background: var(--gradient-danger); 
            color: white; 
            box-shadow: 0 4px 15px rgba(244, 63, 94, 0.4);
        }
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(244, 63, 94, 0.6);
        }
        .btn-success { 
            background: var(--gradient-success); 
            color: white; 
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6);
        }

        /* --- HEADER --- */
        header {
            display: flex; 
            align-items: center; 
            padding: 0 5%; 
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0,0,0,0.2); 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 70px; 
            z-index: 1100;
            border-bottom: 1px solid var(--glass-border);
        }
        .header-content { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            width: 100%; 
        }
        .header-left { 
            display: flex; 
            align-items: center; 
            flex: 1; 
            cursor: pointer;
            gap: 15px;
        }
        .date-display-compact { 
            font-size: 0.85rem; 
            color: var(--text-sub); 
            font-weight: 600;
            white-space: nowrap;
            padding: 6px 12px;
            background: rgba(79, 70, 229, 0.1);
            border-radius: 20px;
            border: 1px solid rgba(79, 70, 229, 0.2);
        }
        .header-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-main);
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .date-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .notification-badge {
            position: relative;
            cursor: pointer;
            transition: transform 0.3s;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .notification-badge:hover {
            transform: scale(1.1);
        }
        .notification-icon {
            font-size: 1.3rem;
            color: var(--text-sub);
            transition: 0.3s;
        }
        .notification-icon.has-notifications {
            color: var(--notification-color);
        }
        .notification-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--gradient-warning);
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .menu-toggle { 
            font-size: 1.5rem; 
            color: var(--primary-color); 
            cursor: pointer; 
            padding: 10px;
            transition: transform 0.3s;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .menu-toggle:hover {
            transform: rotate(90deg);
        }

        /* --- SIDEBAR --- */
        .sidebar {
            position: fixed; 
            top: 85px; 
            right: 15px; 
            height: calc(100vh - 100px);
            width: var(--sidebar-width-collapsed); 
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(15px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
            border-radius: 24px;
            transition: var(--transition); 
            z-index: 1000; 
            padding: 20px 0; 
            overflow: hidden;
            border: 1px solid var(--glass-border);
        }
        .sidebar.expanded { width: var(--sidebar-width-expanded); }
        .nav-list {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .nav-link {
            display: flex; 
            align-items: center; 
            text-decoration: none; 
            color: var(--text-sub);
            height: 55px; 
            margin: 0 10px; 
            border-radius: 16px; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            min-height: 44px;
        }
        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.6s;
        }
        .nav-link:hover::before {
            left: 100%;
        }
        .nav-link i { 
            min-width: 50px; 
            font-size: 1.3rem; 
            display: flex; 
            justify-content: center; 
            z-index: 1;
        }
        .nav-link span { 
            opacity: 0; 
            font-weight: 600; 
            white-space: nowrap; 
            z-index: 1;
        }
        .sidebar.expanded .nav-link span { opacity: 1; }
        .nav-link.active { 
            color: var(--text-main); 
            background: var(--glass-effect);
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
        }
        .nav-link.active i {
            color: var(--primary-color);
        }
        #logoutBtn:hover {
            background: rgba(244, 63, 94, 0.1);
            color: var(--expense-color);
        }
        #logoutBtn:hover i {
            color: var(--expense-color);
        }

        /* --- MAIN CONTENT --- */
        main { 
            margin-top: 70px; 
            margin-right: 85px; 
            padding: 40px; 
            transition: 0.4s; 
        }
        .page { display: none; }
        .page.active { display: block; }

        /* --- DASHBOARD CARDS --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.3), var(--shadow-glow);
        }
        .stat-card.income::before {
            background: var(--gradient-success);
        }
        .stat-card.expense::before {
            background: var(--gradient-danger);
        }
        .stat-card.warning::before {
            background: var(--gradient-warning);
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 10px 0;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .stat-card.income .stat-value {
            background: var(--gradient-success);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .stat-card.expense .stat-value {
            background: var(--gradient-danger);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .stat-change {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            background: rgba(16, 185, 129, 0.1);
            color: var(--income-color);
        }
        .stat-change.negative {
            background: rgba(244, 63, 94, 0.1);
            color: var(--expense-color);
        }

        /* --- RECORDS TABLE --- */
        .table-container {
            overflow-x: auto;
            border-radius: 16px;
            margin-top: 20px;
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
        }
        .records-table { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0;
            min-width: 600px;
        }
        .records-table th { 
            text-align: left; 
            padding: 20px; 
            background: rgba(30, 41, 59, 0.8);
            color: var(--text-sub); 
            font-weight: 600;
            border-bottom: 1px solid var(--glass-border);
            white-space: nowrap;
        }
        .records-table td { 
            padding: 20px; 
            border-bottom: 1px solid var(--glass-border);
            transition: background 0.2s;
        }
        .records-table tr:hover td {
            background: rgba(255, 255, 255, 0.03);
        }
        .records-table tr:last-child td {
            border-bottom: none;
        }
        .amount.expense { 
            color: var(--expense-color); 
            font-weight: 700;
            text-shadow: 0 0 10px rgba(244, 63, 94, 0.3);
        }
        .amount.income { 
            color: var(--income-color); 
            font-weight: 700;
            text-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
        }
        
        /* --- PAYMENT ITEMS --- */
        .payment-item {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 6px solid var(--notification-color);
            transition: all 0.3s;
            border: 1px solid var(--glass-border);
            position: relative;
            overflow: hidden;
        }
        .payment-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .payment-item:hover::before {
            opacity: 1;
        }
        .payment-item.paid {
            border-left-color: var(--income-color);
            opacity: 0.8;
        }
        .payment-item.paid::before {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, transparent 100%);
        }
        .payment-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
            flex-wrap: wrap;
            gap: 10px;
        }
        .payment-header-row {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .category-badge {
            display: inline-block;
            padding: 6px 16px;
            background: rgba(79, 70, 229, 0.1);
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--primary-color);
            border: 1px solid rgba(79, 70, 229, 0.2);
            font-weight: 500;
            white-space: nowrap;
        }
        .payment-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* --- CATEGORY MANAGEMENT --- */
        .category-section {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid var(--glass-border);
        }
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .category-card {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--glass-border);
            transition: all 0.3s;
        }
        .category-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            border-color: var(--primary-color);
        }
        
        /* --- GOALS --- */
        .goal-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 6px solid var(--primary-color);
            border: 1px solid var(--glass-border);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        .goal-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.1) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .goal-card:hover::before {
            opacity: 1;
        }
        .goal-card.income-goal {
            border-left-color: var(--income-color);
        }
        .goal-card.income-goal::before {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, transparent 100%);
        }
        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
            flex-wrap: wrap;
            gap: 10px;
        }
        .goal-progress {
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-top: 15px;
            overflow: hidden;
            position: relative;
            z-index: 1;
        }
        .goal-progress-bar {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 10px;
            transition: width 1s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }
        .goal-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.3), 
                transparent);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .goal-card.income-goal .goal-progress-bar {
            background: var(--gradient-success);
        }
        
        /* --- NOTIFICATION MODAL --- */
        .notification-modal {
            display: none;
            position: fixed;
            top: 80px;
            right: 100px;
            width: 400px;
            background: var(--bg-card);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3), var(--shadow-glow);
            z-index: 2000;
            padding: 25px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(20px);
        }
        .notification-modal.active {
            display: block;
            animation: slideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .notification-item {
            padding: 15px;
            border-bottom: 1px solid var(--glass-border);
            font-size: 0.9rem;
            transition: background 0.2s;
        }
        .notification-item:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        .notification-item:last-child {
            border-bottom: none;
        }
        .notification-warning {
            color: var(--notification-color);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.4), var(--shadow-glow);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--glass-border);
            animation: modalAppear 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-sub);
            transition: color 0.2s;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-close:hover {
            color: var(--expense-color);
        }
        
        /* --- OVERLAY --- */
        .overlay {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: rgba(0,0,0,0.5); 
            opacity: 0; 
            visibility: hidden; 
            z-index: 999;
            transition: var(--transition);
            backdrop-filter: blur(5px);
        }
        .overlay.active { 
            opacity: 1; 
            visibility: visible; 
        }

        /* --- GR√ÅFICOS MODERNOS 2026 --- */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }
        .chart-card {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 25px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .chart-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            z-index: 1;
        }
        .chart-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3), var(--shadow-glow);
        }
        .chart-card.warning::before {
            background: var(--gradient-warning);
        }
        .chart-card.success::before {
            background: var(--gradient-success);
        }
        .chart-card.danger::before {
            background: var(--gradient-danger);
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
            flex-wrap: wrap;
            gap: 10px;
        }
        .chart-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .chart-container {
            height: 280px;
            position: relative;
            margin-top: 10px;
        }
        .no-data-message {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-sub);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
        }
        .no-data-message i {
            font-size: 3rem;
            margin-bottom: 15px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            opacity: 0.5;
        }

        /* --- PREDICTIVE INSIGHTS --- */
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }
        .insight-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid var(--glass-border);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        .insight-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(79, 70, 229, 0.1) 0%, 
                rgba(16, 185, 129, 0.1) 50%, 
                transparent 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .insight-card:hover::before {
            opacity: 1;
        }
        .insight-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 15px;
            background: var(--gradient-primary);
            color: white;
        }
        .insight-card.warning .insight-icon {
            background: var(--gradient-warning);
        }
        .insight-card.success .insight-icon {
            background: var(--gradient-success);
        }

        /* --- FORM ROW --- */
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .form-row .form-group {
            flex: 1;
            min-width: 150px;
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 1024px) {
            .charts-grid,
            .insights-grid,
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .categories-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }
        @media (max-width: 768px) {
            main { 
                margin-right: 0; 
                padding: 20px; 
            }
            .sidebar { 
                right: 10px; 
                top: 85px;
                bottom: auto;
                height: calc(100vh - 100px);
                position: fixed;
            }
            .header-content { 
                flex-direction: column; 
                align-items: flex-start; 
                gap: 10px; 
            }
            .header-right { 
                width: 100%; 
                justify-content: space-between; 
            }
            .date-selector { 
                flex-wrap: wrap; 
            }
            .notification-modal {
                right: 20px;
                width: calc(100% - 40px);
            }
            .categories-grid {
                grid-template-columns: 1fr;
            }
            .modal-content {
                padding: 20px;
            }
            .chart-card {
                padding: 20px;
            }
            .chart-container {
                height: 250px;
            }
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .form-row .form-group {
                min-width: 100%;
            }
            input, select, textarea {
                font-size: 16px !important;
            }
        }
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .chart-container {
                height: 220px;
            }
            .auth-card {
                padding: 25px;
            }
        }
    </style>
</head>
<body>

    <div id="authScreen">
        <div class="auth-card">
            <h2 id="authTitle">Entrar no Sistema</h2>
            <p id="authDesc" style="color: var(--text-sub); margin-bottom: 20px;">Organize as suas finan√ßas agora</p>
            <div class="form-group">
                <label>E-mail</label>
                <input type="email" id="email" class="form-control" placeholder="exemplo@email.com">
            </div>
            <div class="form-group">
                <label>Senha</label>
                <div class="password-wrapper">
                    <input type="password" id="password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    <i class="fa-solid fa-eye password-toggle-icon" id="togglePassword" onclick="togglePasswordVisibility()"></i>
                </div>
            </div>
            <button class="btn btn-primary" id="mainAuthBtn" onclick="handleAuth()">Entrar</button>
            <button class="btn btn-ghost" onclick="forgotPassword()">Esqueci a minha senha</button>
            <div id="authFooter" style="margin-top: 20px; font-size: 0.9rem;">
                N√£o tem conta? <span onclick="toggleAuthMode()" style="color: var(--primary-color); cursor: pointer; font-weight: 600;">Criar conta</span>
            </div>
        </div>
    </div>

    <!-- Modal de importa√ß√£o -->
    <div class="modal-overlay" id="importModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Importar Dados</h3>
                <button class="modal-close" onclick="closeImportModal()">√ó</button>
            </div>
            <div class="form-group">
                <label>Selecione o tipo de dados:</label>
                <select id="importType" class="form-control">
                    <option value="expenses">Despesas</option>
                    <option value="income">Ganhos</option>
                    <option value="payments">Pagamentos</option>
                    <option value="expenseCategories">Categorias de Despesas</option>
                    <option value="incomeCategories">Categorias de Ganhos</option>
                </select>
            </div>
            <div class="form-group">
                <label>Selecione o arquivo (JSON):</label>
                <input type="file" id="importFile" class="form-control" accept=".json">
            </div>
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" style="background: var(--gradient-success); width: 100%;" onclick="processImport()">
                    <i class="fa-solid fa-file-import"></i> Importar Dados
                </button>
            </div>
            <div style="margin-top: 15px; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                <p style="font-size: 0.85rem; color: var(--text-sub);">
                    <strong>Nota:</strong> O arquivo deve estar no formato JSON. Use primeiro a fun√ß√£o de exporta√ß√£o para ver o formato correto.
                </p>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o de Exclus√£o -->
    <div class="modal-overlay" id="confirmDeleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirmar Exclus√£o em Massa</h3>
                <button class="modal-close" onclick="closeDeleteConfirmation()">√ó</button>
            </div>
            <p style="color: var(--text-sub); margin-bottom: 20px;">
                <strong>Aten√ß√£o!</strong> Esta a√ß√£o √© <strong>irrevers√≠vel</strong>. Todos os dados de <strong id="deleteDataTypeDisplay"></strong> do per√≠odo <strong id="deleteMonthDisplay"></strong> ser√£o permanentemente apagados.
            </p>
            <div class="form-group">
                <label>Para confirmar, insira a sua senha de login:</label>
                <input type="password" id="deleteConfirmPassword" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <button class="btn btn-ghost" style="width: 100%;" onclick="closeDeleteConfirmation()">Cancelar</button>
                <button class="btn btn-danger" style="width: 100%;" onclick="handleConfirmDelete()">
                    <i class="fa-solid fa-triangle-exclamation"></i> Confirmar Exclus√£o
                </button>
            </div>
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="closeSidebar()"></div>

    <header>
        <div class="header-content">
            <div class="header-left" onclick="goToDashboard()">
                <div class="date-display-compact" id="currentDate"></div>
                <div class="header-title">Meu Financeiro</div>
            </div>
            <div class="header-right">
                <div class="date-selector">
                    <select id="monthSelect" class="select-control" onchange="updateSelectedDate()">
                        <option value="01">Jan</option>
                        <option value="02">Fev</option>
                        <option value="03">Mar</option>
                        <option value="04">Abr</option>
                        <option value="05">Mai</option>
                        <option value="06">Jun</option>
                        <option value="07">Jul</option>
                        <option value="08">Ago</option>
                        <option value="09">Set</option>
                        <option value="10">Out</option>
                        <option value="11">Nov</option>
                        <option value="12">Dez</option>
                    </select>
                    <select id="yearSelect" class="select-control" onchange="updateSelectedDate()">
                        <!-- Op√ß√µes ser√£o preenchidas via JavaScript (2026-2030) -->
                    </select>
                    <button class="btn btn-sm btn-primary" onclick="goToToday()">Hoje</button>
                </div>
                <div class="notification-badge" id="notificationBadge" onclick="toggleNotifications()">
                    <i class="fa-solid fa-bell notification-icon" id="notificationIcon"></i>
                    <div class="notification-count" id="notificationCount" style="display: none;">0</div>
                </div>
                <div class="menu-toggle" id="menuToggleBtn"><i class="fa-solid fa-bars-staggered"></i></div>
            </div>
        </div>
    </header>

    <!-- Modal de Notifica√ß√µes -->
    <div class="notification-modal" id="notificationModal">
        <h3 style="margin-bottom: 15px;">Notifica√ß√µes</h3>
        <div id="notificationsList">
            <!-- Notifica√ß√µes ser√£o inseridas aqui -->
        </div>
    </div>

    <aside class="sidebar" id="sidebar">
        <nav class="nav-list">
            <a href="#" class="nav-link" data-page="dashboard"><i class="fa-solid fa-chart-line"></i> <span>Dashboard</span></a>
            <a href="#" class="nav-link" data-page="expenses"><i class="fa-solid fa-receipt"></i> <span>Despesas</span></a>
            <a href="#" class="nav-link" data-page="income"><i class="fa-solid fa-wallet"></i> <span>Ganhos</span></a>
            <a href="#" class="nav-link" data-page="payments"><i class="fa-solid fa-credit-card"></i> <span>Contas a Pagar</span></a>
            <a href="#" class="nav-link" data-page="goals"><i class="fa-solid fa-bullseye"></i> <span>Metas</span></a>
            <a href="#" class="nav-link" data-page="data"><i class="fa-solid fa-database"></i> <span>Dados</span></a>
            <a href="#" class="nav-link" id="logoutBtn" style="margin-top: auto;"><i class="fa-solid fa-right-from-bracket"></i> <span>Sair</span></a>
        </nav>
    </aside>

    <main>
        <div id="dashboard" class="page active">
            <h1 style="margin-bottom: 5px;">Ol√°, <span id="userName">Usu√°rio</span> üëã</h1>
            <p style="color: var(--text-sub); margin-bottom: 25px;">Bem-vindo ao seu painel financeiro inteligente</p>
            
            <!-- Cart√µes de Estat√≠sticas -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <div style="color: var(--text-sub); font-size: 0.9rem;">Total de Despesas</div>
                            <div class="stat-value" id="totalExpenses">R$ 0,00</div>
                        </div>
                        <div style="width: 50px; height: 50px; border-radius: 12px; background: rgba(244, 63, 94, 0.1); display: flex; align-items: center; justify-content: center;">
                            <i class="fa-solid fa-arrow-trend-down" style="color: var(--expense-color); font-size: 1.5rem;"></i>
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <span class="stat-change negative" id="expenseChange">
                            <i class="fa-solid fa-arrow-up"></i> 0%
                        </span>
                        <span style="color: var(--text-sub); font-size: 0.85rem; margin-left: 10px;">vs m√™s anterior</span>
                    </div>
                </div>
                
                <div class="stat-card income">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <div style="color: var(--text-sub); font-size: 0.9rem;">Total de Ganhos</div>
                            <div class="stat-value" id="totalIncome">R$ 0,00</div>
                        </div>
                        <div style="width: 50px; height: 50px; border-radius: 12px; background: rgba(16, 185, 129, 0.1); display: flex; align-items: center; justify-content: center;">
                            <i class="fa-solid fa-arrow-trend-up" style="color: var(--income-color); font-size: 1.5rem;"></i>
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <span class="stat-change" id="incomeChange">
                            <i class="fa-solid fa-arrow-up"></i> 0%
                        </span>
                        <span style="color: var(--text-sub); font-size: 0.85rem; margin-left: 10px;">vs m√™s anterior</span>
                    </div>
                </div>
                
                <div class="stat-card warning">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <div style="color: var(--text-sub); font-size: 0.9rem;">Saldo do M√™s</div>
                            <div class="stat-value" id="monthBalance">R$ 0,00</div>
                        </div>
                        <div style="width: 50px; height: 50px; border-radius: 12px; background: rgba(245, 158, 11, 0.1); display: flex; align-items: center; justify-content: center;">
                            <i class="fa-solid fa-scale-balanced" style="color: var(--notification-color); font-size: 1.5rem;"></i>
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <span class="stat-change" id="balanceChange">
                            <i class="fa-solid fa-minus"></i> 0%
                        </span>
                        <span style="color: var(--text-sub); font-size: 0.85rem; margin-left: 10px;">vs m√™s anterior</span>
                    </div>
                </div>
            </div>

            <!-- Gr√°ficos Modernos 2026 -->
            <div class="charts-grid">
                <!-- Gr√°fico de Barras Horizontais - Despesas vs Metas -->
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">
                            <i class="fa-solid fa-scale-balanced"></i> Despesas vs Metas
                        </div>
                        <div style="color: var(--text-sub); font-size: 0.85rem;">Compara√ß√£o por categoria</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="expensesVsGoalsChart"></canvas>
                        <div class="no-data-message" id="noExpenseGoalDataMessage" style="display: none;">
                            <i class="fa-solid fa-chart-bar"></i>
                            <p>Adicione metas de despesa para ver a compara√ß√£o</p>
                        </div>
                    </div>
                </div>
                
                <!-- Gr√°fico de Doughnut 3D - Distribui√ß√£o de Despesas -->
                <div class="chart-card danger">
                    <div class="chart-header">
                        <div class="chart-title">
                            <i class="fa-solid fa-chart-pie"></i> Distribui√ß√£o de Despesas
                        </div>
                        <div style="color: var(--text-sub); font-size: 0.85rem;">Este m√™s</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="expenseDoughnutChart"></canvas>
                        <div class="no-data-message" id="noExpenseDataMessage" style="display: none;">
                            <i class="fa-solid fa-chart-pie"></i>
                            <p>Nenhuma despesa registrada este m√™s</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="charts-grid">
                <!-- Gr√°fico de √Årea com Gradiente - Evolu√ß√£o Mensal -->
                <div class="chart-card success">
                    <div class="chart-header">
                        <div class="chart-title">
                            <i class="fa-solid fa-chart-area"></i> Evolu√ß√£o Financeira
                        </div>
                        <div style="color: var(--text-sub); font-size: 0.85rem;">√öltimos 6 meses</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="evolutionAreaChart"></canvas>
                        <div class="no-data-message" id="noEvolutionDataMessage" style="display: none;">
                            <i class="fa-solid fa-chart-line"></i>
                            <p>N√£o h√° dados suficientes para mostrar a evolu√ß√£o</p>
                        </div>
                    </div>
                </div>
                
                <!-- Gr√°fico de Barras Horizontal - Top Categorias -->
                <div class="chart-card warning">
                    <div class="chart-header">
                        <div class="chart-title">
                            <i class="fa-solid fa-chart-bar"></i> Top 5 Categorias
                        </div>
                        <div style="color: var(--text-sub); font-size: 0.85rem;">Maiores gastos</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="topCategoriesChart"></canvas>
                        <div class="no-data-message" id="noCategoriesDataMessage" style="display: none;">
                            <i class="fa-solid fa-chart-bar"></i>
                            <p>Nenhuma categoria com dados suficientes</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Insights Preditivos -->
            <h2 style="margin: 40px 0 20px 0;">üìà Insights Preditivos</h2>
            <div class="insights-grid">
                <div class="insight-card">
                    <div class="insight-icon">
                        <i class="fa-solid fa-lightbulb"></i>
                    </div>
                    <h3 style="margin-bottom: 10px;">Previs√£o do M√™s</h3>
                    <p style="color: var(--text-sub); margin-bottom: 15px;">Com base nos seus padr√µes de gastos</p>
                    <div class="goal-progress" style="margin-top: 20px;">
                        <div class="goal-progress-bar" style="width: 65%;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.9rem;">
                        <span style="color: var(--text-sub);">Saldo previsto:</span>
                        <span style="color: var(--income-color); font-weight: 600;" id="predictedBalance">R$ 0,00</span>
                    </div>
                </div>
                
                <div class="insight-card warning">
                    <div class="insight-icon">
                        <i class="fa-solid fa-bell"></i>
                    </div>
                    <h3 style="margin-bottom: 10px;">Alertas Inteligentes</h3>
                    <p style="color: var(--text-sub); margin-bottom: 15px;">Recomenda√ß√µes baseadas em IA</p>
                    <div id="smartAlertContainer" style="background: rgba(245, 158, 11, 0.1); padding: 12px; border-radius: 12px; margin-top: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fa-solid fa-lightbulb" style="color: var(--notification-color);"></i>
                            <span style="font-size: 0.9rem;" id="smartAlertText">Analisando seus gastos...</span>
                        </div>
                    </div>
                </div>
                
                <div class="insight-card success">
                    <div class="insight-icon">
                        <i class="fa-solid fa-chart-line"></i>
                    </div>
                    <h3 style="margin-bottom: 10px;">Tend√™ncias</h3>
                    <p style="color: var(--text-sub); margin-bottom: 15px;">Sua evolu√ß√£o mensal</p>
                    <div style="display: flex; align-items: center; gap: 15px; margin-top: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: 700; color: var(--income-color);" id="incomeTrend">+0%</div>
                            <div style="font-size: 0.8rem; color: var(--text-sub);">Ganhos</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: 700; color: var(--expense-color);" id="expenseTrend">+0%</div>
                            <div style="font-size: 0.8rem; color: var(--text-sub);">Despesas</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="expenses" class="page">
            <h2>Despesas - <span id="expensesPeriod"></span></h2>
            <div style="background: var(--bg-card); padding: 25px; border-radius: 20px; margin-bottom: 30px; border: 1px solid var(--glass-border);">
                <h3 style="margin-bottom: 20px;">Adicionar Nova Despesa</h3>
                <div class="form-group">
                    <label>Descri√ß√£o</label>
                    <input type="text" id="expItem" class="form-control" placeholder="Ex: Supermercado, Restaurante, Combust√≠vel...">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Valor (R$)</label>
                        <input type="number" id="expValue" class="form-control" placeholder="0.00" step="0.01" min="0.01">
                    </div>
                    <div class="form-group">
                        <label>Categoria</label>
                        <select id="expCategory" class="form-control">
                            <option value="">Selecione uma categoria</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Data</label>
                        <input type="date" id="expDate" class="form-control">
                    </div>
                </div>
                <button class="btn btn-primary" style="width: auto; margin-top: 10px;" onclick="addExpense()">
                    <i class="fa-solid fa-plus"></i> Salvar Despesa
                </button>
            </div>

            <h3>Despesas Registradas</h3>
            <div class="table-container">
                <table class="records-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Categoria</th>
                            <th>Valor</th>
                            <th>Data</th>
                            <th>A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="expensesTable">
                        <!-- Despesas ser√£o inseridas aqui -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="income" class="page">
            <h2>Ganhos - <span id="incomePeriod"></span></h2>
            <div style="background: var(--bg-card); padding: 25px; border-radius: 20px; margin-bottom: 30px; border: 1px solid var(--glass-border);">
                <h3 style="margin-bottom: 20px;">Adicionar Novo Ganho</h3>
                <div class="form-group">
                    <label>Descri√ß√£o</label>
                    <input type="text" id="incItem" class="form-control" placeholder="Ex: Sal√°rio, Freelance, Investimentos...">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Valor (R$)</label>
                        <input type="number" id="incValue" class="form-control" placeholder="0.00" step="0.01" min="0.01">
                    </div>
                    <div class="form-group">
                        <label>Categoria</label>
                        <select id="incCategory" class="form-control">
                            <option value="">Selecione uma categoria</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Data</label>
                        <input type="date" id="incDate" class="form-control">
                    </div>
                </div>
                <button class="btn btn-primary" style="width: auto; margin-top: 10px; background: var(--gradient-success);" onclick="addIncome()">
                    <i class="fa-solid fa-plus"></i> Salvar Ganho
                </button>
            </div>

            <h3>Ganhos Registrados</h3>
            <div class="table-container">
                <table class="records-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Categoria</th>
                            <th>Valor</th>
                            <th>Data</th>
                            <th>A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="incomeTable">
                        <!-- Ganhos ser√£o inseridas aqui -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="payments" class="page">
            <h2>Contas a Pagar - <span id="paymentsPeriod"></span></h2>
            
            <div style="background: var(--bg-card); padding: 25px; border-radius: 20px; margin-bottom: 30px; border: 1px solid var(--glass-border);">
                <h3 style="margin-bottom: 20px;">Adicionar Nova Conta a Pagar</h3>
                <div class="form-group">
                    <label>Descri√ß√£o</label>
                    <input type="text" id="payItem" class="form-control" placeholder="Ex: Aluguel, Fatura Cart√£o, Condom√≠nio...">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Valor (R$)</label>
                        <input type="number" id="payValue" class="form-control" placeholder="0.00" step="0.01" min="0.01">
                    </div>
                    <div class="form-group">
                        <label>Categoria</label>
                        <select id="payCategory" class="form-control">
                            <option value="">Selecione uma categoria</option>
                            <!-- Categorias ser√£o preenchidas dinamicamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Data de Vencimento</label>
                        <input type="date" id="payDueDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Situa√ß√£o</label>
                        <select id="payStatus" class="form-control">
                            <option value="pending">Pendente</option>
                            <option value="paid">Pago</option>
                            <option value="overdue">Atrasado</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" style="width: auto; margin-top: 10px; background: var(--gradient-warning);" onclick="addPayment()">
                    <i class="fa-solid fa-plus"></i> Salvar Conta
                </button>
            </div>

            <h3>Contas a Pagar</h3>
            <div class="payment-list" id="paymentList">
                <!-- Contas ser√£o inseridas aqui dinamicamente -->
                <div style="text-align: center; padding: 40px; color: var(--text-sub);">
                    <i class="fa-solid fa-credit-card" style="font-size: 3rem; opacity: 0.3; margin-bottom: 15px;"></i>
                    <p>Nenhuma conta a pagar registrada</p>
                </div>
            </div>
        </div>

        <div id="goals" class="page">
            <h2>Metas - <span id="goalsPeriod"></span></h2>
            
            <div class="category-section">
                <h3>Metas de Despesas por Categoria</h3>
                <div class="form-group" style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <select id="expenseGoalCategory" class="form-control">
                        <option value="">Selecione uma categoria</option>
                    </select>
                    <input type="number" id="expenseGoalTarget" class="form-control" placeholder="Valor da meta (R$)" step="0.01">
                    <button class="btn btn-primary" style="width: auto;" onclick="addExpenseGoal()">
                        <i class="fa-solid fa-plus"></i> Adicionar Meta
                    </button>
                </div>
                <div id="expenseGoalsList">
                    <!-- Metas de despesas ser√£o inseridas aqui -->
                </div>
            </div>
            
            <div class="category-section">
                <h3>Metas de Ganhos por Categoria</h3>
                <div class="form-group" style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <select id="incomeGoalCategory" class="form-control">
                        <option value="">Selecione uma categoria</option>
                    </select>
                    <input type="number" id="incomeGoalTarget" class="form-control" placeholder="Valor da meta (R$)" step="0.01">
                    <button class="btn btn-primary" style="width: auto; background: var(--gradient-success);" onclick="addIncomeGoal()">
                        <i class="fa-solid fa-plus"></i> Adicionar Meta
                    </button>
                </div>
                <div id="incomeGoalsList">
                    <!-- Metas de ganhos ser√£o inseridas aqui -->
                </div>
            </div>
        </div>

        <div id="data" class="page">
            <h2>Dados - <span id="dataPeriod"></span></h2>
            
            <div class="category-section">
                <h3>Gerenciar Categorias de Despesas</h3>
                <div class="form-group" style="display: flex; gap: 10px;">
                    <input type="text" id="newExpenseCategory" class="form-control" placeholder="Nova categoria de despesa">
                    <button class="btn btn-primary" style="width: auto;" onclick="addExpenseCategory()">
                        <i class="fa-solid fa-plus"></i> Adicionar
                    </button>
                </div>
                <div class="categories-grid" id="expenseCategoriesList">
                    <!-- Categorias de despesas ser√£o listadas aqui -->
                </div>
            </div>
            
            <div class="category-section">
                <h3>Gerenciar Categorias de Ganhos</h3>
                <div class="form-group" style="display: flex; gap: 10px;">
                    <input type="text" id="newIncomeCategory" class="form-control" placeholder="Nova categoria de ganho">
                    <button class="btn btn-primary" style="width: auto; background: var(--gradient-success);" onclick="addIncomeCategory()">
                        <i class="fa-solid fa-plus"></i> Adicionar
                    </button>
                </div>
                <div class="categories-grid" id="incomeCategoriesList">
                    <!-- Categorias de ganhos ser√£o listadas aqui -->
                </div>
            </div>

            <div class="category-section">
                <h3>Backup e Importa√ß√£o de Dados</h3>
                
                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 15px;">
                    <button class="btn btn-primary" onclick="exportToExcel()" style="width: auto;">
                        <i class="fa-solid fa-file-excel"></i> Exportar para JSON
                    </button>
                    
                    <button class="btn btn-primary" onclick="openImportModal()" style="width: auto; background: var(--gradient-success);">
                        <i class="fa-solid fa-file-import"></i> Importar Dados
                    </button>
                    
                    <button class="btn btn-danger" onclick="exportToExcel()" style="width: auto;">
                        <i class="fa-solid fa-download"></i> Backup Completo
                    </button>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                    <p style="font-size: 0.9rem; color: var(--text-sub);">
                        <strong>Exporta√ß√£o:</strong> Gera um arquivo JSON com todos os seus dados financeiros.<br>
                        <strong>Importa√ß√£o:</strong> Permite importar dados espec√≠ficos a partir de arquivos JSON.<br>
                        <strong>Backup:</strong> Cria um backup completo em formato JSON.
                    </p>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts principais -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, sendPasswordResetEmail, signOut, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, deleteDoc, updateDoc, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAFhPVMxHtF8313MNCmupbGLA8WToyeX5o",
            authDomain: "meu-financeiro-8d0f4.firebaseapp.com",
            projectId: "meu-financeiro-8d0f4",
            storageBucket: "meu-financeiro-8d0f4.firebasestorage.app",
            messagingSenderId: "299066355372",
            appId: "1:299066355372:web:08feb8ba15d657a3b3909"
        };

        // Vari√°veis globais que precisam ser acess√≠veis pelas fun√ß√µes dos bot√µes
        window.firebaseApp = null;
        window.firebaseAuth = null;
        window.firebaseDb = null;
        window.firebaseInitialized = false;
        window.selectedDate = {
            month: new Date().getMonth() + 1,
            year: new Date().getFullYear()
        };
        window.expenseCategories = [];
        window.incomeCategories = [];
        window.deleteDataType = null;

        try {
            window.firebaseApp = initializeApp(firebaseConfig);
            window.firebaseAuth = getAuth(window.firebaseApp);
            window.firebaseDb = getFirestore(window.firebaseApp);
            window.firebaseInitialized = true;
        } catch (error) {
            console.error("Erro ao inicializar Firebase:", error);
            document.getElementById('authScreen').innerHTML = `
                <div class="auth-card">
                    <h2>Erro de Conex√£o</h2>
                    <p style="color: var(--text-sub); margin-bottom: 20px;">
                        N√£o foi poss√≠vel conectar ao servidor. Verifique sua conex√£o com a internet.
                    </p>
                    <button class="btn btn-primary" onclick="location.reload()">
                        <i class="fa-solid fa-refresh"></i> Tentar Novamente
                    </button>
                </div>
            `;
        }

        if (window.firebaseInitialized) {
            // Configura√ß√£o de vari√°veis globais
            window.isLoginMode = true;
            window.notifications = [];
            
            // Vari√°veis para gr√°ficos
            window.expensesVsGoalsChart = null;
            window.expenseDoughnutChart = null;
            window.evolutionAreaChart = null;
            window.topCategoriesChart = null;

            window.formatCurrency = (value) => {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL',
                    minimumFractionDigits: 2
                }).format(value || 0);
            };

            window.getCurrentDate = function() {
                const today = new Date();
                return today.toISOString().split('T')[0];
            };

            window.initializeDateSelector = function() {
                const yearSelect = document.getElementById('yearSelect');
                yearSelect.innerHTML = '';
                
                // Adiciona 5 anos a partir do ano atual
                const currentYear = new Date().getFullYear();
                for (let year = currentYear - 2; year <= currentYear + 3; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    option.selected = year === window.selectedDate.year;
                    yearSelect.appendChild(option);
                }
                
                const monthSelect = document.getElementById('monthSelect');
                monthSelect.value = window.selectedDate.month.toString().padStart(2, '0');
                
                updatePeriodDisplays();
                updateCurrentDateDisplay();
            };

            function updateCurrentDateDisplay() {
                const now = new Date();
                const options = { 
                    day: 'numeric', 
                    month: 'short',
                    year: 'numeric'
                };
                const currentDateEl = document.getElementById('currentDate');
                if (currentDateEl) {
                    currentDateEl.innerText = now.toLocaleDateString('pt-BR', options);
                }
            }

            window.goToToday = function() {
                const today = new Date();
                window.selectedDate = {
                    month: today.getMonth() + 1,
                    year: today.getFullYear()
                };
                document.getElementById('monthSelect').value = (today.getMonth() + 1).toString().padStart(2, '0');
                document.getElementById('yearSelect').value = today.getFullYear();
                updateSelectedDate();
            };

            window.updateSelectedDate = function() {
                const monthSelect = document.getElementById('monthSelect');
                const yearSelect = document.getElementById('yearSelect');
                
                // Garante que o m√™s seja um n√∫mero v√°lido (1-12)
                let month = parseInt(monthSelect.value);
                if (isNaN(month) || month < 1 || month > 12) {
                    month = new Date().getMonth() + 1;
                    monthSelect.value = month.toString().padStart(2, '0');
                }
                
                let year = parseInt(yearSelect.value);
                if (isNaN(year) || year < 2000 || year > 2100) {
                    year = new Date().getFullYear();
                    yearSelect.value = year.toString();
                }
                
                window.selectedDate = {
                    month: month,
                    year: year
                };
                
                updatePeriodDisplays();
                checkDuePaymentsNotifications();
                loadGoals();
                loadStats();
                loadModernCharts();
                updateSmartAlert();
                
                // Recarrega as listas de despesas e ganhos
                sync("expenses", "expensesTable");
                sync("income", "incomeTable");
                loadPayments();
            };

            function updatePeriodDisplays() {
                const monthNames = [
                    'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                ];
                
                const periodString = `${monthNames[window.selectedDate.month - 1]} de ${window.selectedDate.year}`;
                
                document.getElementById('expensesPeriod').textContent = periodString;
                document.getElementById('incomePeriod').textContent = periodString;
                document.getElementById('paymentsPeriod').textContent = periodString;
                document.getElementById('goalsPeriod').textContent = periodString;
                document.getElementById('dataPeriod').textContent = periodString;
            }

            window.loadCategories = async function() {
                if (!window.firebaseAuth.currentUser) return;
                
                const expenseCategoriesRef = collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/expenseCategories`);
                onSnapshot(expenseCategoriesRef, (snapshot) => {
                    window.expenseCategories = [];
                    snapshot.forEach(doc => {
                        window.expenseCategories.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    updateCategoryDropdown('expCategory', window.expenseCategories);
                    updateCategoryDropdown('expenseGoalCategory', window.expenseCategories);
                    updateCategoryDropdown('payCategory', window.expenseCategories);
                    updateCategoriesList('expenseCategoriesList', window.expenseCategories, 'expense');
                });
                
                const incomeCategoriesRef = collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/incomeCategories`);
                onSnapshot(incomeCategoriesRef, (snapshot) => {
                    window.incomeCategories = [];
                    snapshot.forEach(doc => {
                        window.incomeCategories.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    updateCategoryDropdown('incCategory', window.incomeCategories);
                    updateCategoryDropdown('incomeGoalCategory', window.incomeCategories);
                    updateCategoriesList('incomeCategoriesList', window.incomeCategories, 'income');
                });
            };

            function updateCategoryDropdown(elementId, categories) {
                const dropdown = document.getElementById(elementId);
                if (!dropdown) return;
                
                const currentValue = dropdown.value;
                const firstOption = dropdown.querySelector('option[value=""]') ? '' : '<option value="">Selecione uma categoria</option>';
                dropdown.innerHTML = firstOption;
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.name;
                    option.textContent = category.name;
                    dropdown.appendChild(option);
                });
                
                if (currentValue && categories.some(c => c.name === currentValue)) {
                    dropdown.value = currentValue;
                }
            }

            function updateCategoriesList(elementId, categories, type) {
                const container = document.getElementById(elementId);
                if (!container) return;
                
                container.innerHTML = '';
                
                if (categories.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-sub); text-align: center;">Nenhuma categoria cadastrada</p>';
                    return;
                }
                
                categories.forEach(category => {
                    const card = document.createElement('div');
                    card.className = 'category-card';
                    card.innerHTML = `
                        <span>${category.name}</span>
                        <button class="btn btn-sm btn-danger" onclick="deleteCategory('${type}', '${category.id}')">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    `;
                    container.appendChild(card);
                });
            }

            window.addExpenseCategory = async function() {
                const name = document.getElementById('newExpenseCategory').value.trim();
                if (!name) {
                    alert("Digite o nome da categoria!");
                    return;
                }
                
                try {
                    await addDoc(collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/expenseCategories`), {
                        name: name,
                        createdAt: new Date().toISOString()
                    });
                    
                    document.getElementById('newExpenseCategory').value = '';
                    alert("Categoria de despesa adicionada!");
                } catch (error) {
                    alert("Erro ao adicionar categoria: " + error.message);
                }
            };

            window.addIncomeCategory = async function() {
                const name = document.getElementById('newIncomeCategory').value.trim();
                if (!name) {
                    alert("Digite o nome da categoria!");
                    return;
                }
                
                try {
                    await addDoc(collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/incomeCategories`), {
                        name: name,
                        createdAt: new Date().toISOString()
                    });
                    
                    document.getElementById('newIncomeCategory').value = '';
                    alert("Categoria de ganho adicionada!");
                } catch (error) {
                    alert("Erro ao adicionar categoria: " + error.message);
                }
            };

            window.addPayment = async function() {
                const item = document.getElementById('payItem').value;
                const value = parseFloat(document.getElementById('payValue').value);
                const category = document.getElementById('payCategory').value;
                const dueDate = document.getElementById('payDueDate').value || getCurrentDate();
                const status = document.getElementById('payStatus').value;
                
                if (!item || !value || !category) {
                    alert("Preencha todos os campos obrigat√≥rios!");
                    return;
                }
                
                if (isNaN(value) || value <= 0) {
                    alert("Digite um valor v√°lido!");
                    return;
                }
                
                try {
                    // Extrai m√™s e ano da data fornecida
                    const dateObj = new Date(dueDate + 'T00:00:00-03:00');
                    const month = dateObj.getUTCMonth() + 1;
                    const year = dateObj.getUTCFullYear();
                    
                    await addDoc(collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/payments`), { 
                        item, 
                        value, 
                        category,
                        dueDate,
                        status,
                        month: month,
                        year: year,
                        createdAt: new Date().toISOString()
                    });
                    
                    document.getElementById('payItem').value = ''; 
                    document.getElementById('payValue').value = '';
                    document.getElementById('payCategory').value = '';
                    document.getElementById('payDueDate').value = getCurrentDate();
                    document.getElementById('payStatus').value = 'pending';
                    
                    alert("Conta a pagar registrada com sucesso!");
                    
                    // Atualiza a lista de pagamentos
                    loadPayments();
                    
                } catch (error) {
                    alert("Erro ao registrar conta a pagar: " + error.message);
                }
            };

            window.loadPayments = async function() {
                if (!window.firebaseAuth.currentUser) return;
                
                try {
                    const paymentsRef = collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/payments`);
                    const q = query(
                        paymentsRef,
                        where("month", "==", window.selectedDate.month),
                        where("year", "==", window.selectedDate.year)
                    );
                    
                    const snapshot = await getDocs(q);
                    const container = document.getElementById('paymentList');
                    container.innerHTML = '';
                    
                    if (snapshot.empty) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: var(--text-sub);">
                                <i class="fa-solid fa-credit-card" style="font-size: 3rem; opacity: 0.3; margin-bottom: 15px;"></i>
                                <p>Nenhuma conta a pagar registrada para ${window.selectedDate.month.toString().padStart(2, '0')}/${window.selectedDate.year}</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Ordenar localmente por data de vencimento
                    const sortedDocs = [...snapshot.docs].sort((a, b) => {
                        const dateA = a.data().dueDate || '';
                        const dateB = b.data().dueDate || '';
                        return dateA.localeCompare(dateB);
                    });
                    
                    sortedDocs.forEach(doc => {
                        const data = doc.data();
                        const statusColors = {
                            'pending': 'var(--notification-color)',
                            'paid': 'var(--income-color)',
                            'overdue': 'var(--expense-color)'
                        };
                        
                        const statusTexts = {
                            'pending': 'Pendente',
                            'paid': 'Pago',
                            'overdue': 'Atrasado'
                        };
                        
                        const paymentItem = document.createElement('div');
                        paymentItem.className = `payment-item ${data.status === 'paid' ? 'paid' : ''}`;
                        paymentItem.style.borderLeftColor = statusColors[data.status] || 'var(--notification-color)';
                        
                        // Determinar se mostra o bot√£o de marcar como pago
                        const showMarkAsPaid = data.status !== 'paid';
                        
                        paymentItem.innerHTML = `
                            <div class="payment-header">
                                <div>
                                    <strong>${data.item}</strong>
                                    <div class="payment-header-row">
                                        <span class="category-badge">${data.category}</span>
                                        <span style="color: ${statusColors[data.status]}; font-weight: 600;">
                                            ${statusTexts[data.status]}
                                        </span>
                                        <span style="font-size: 1.2rem; font-weight: 700; color: ${data.status === 'paid' ? 'var(--income-color)' : 'var(--expense-color)'};">
                                            ${formatCurrency(data.value)}
                                        </span>
                                        <span style="font-size: 0.85rem; color: var(--text-sub);">
                                            Vencimento: ${new Date(data.dueDate + 'T00:00:00-03:00').toLocaleDateString('pt-BR')}
                                        </span>
                                        ${data.status === 'paid' ? '<span style="color: var(--income-color);"><i class="fa-solid fa-check-circle"></i> Pago</span>' : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="payment-actions">
                                ${showMarkAsPaid ? `
                                    <button class="btn btn-sm btn-success" onclick="markAsPaid('${doc.id}')">
                                        <i class="fa-solid fa-check"></i> Marcar como Pago
                                    </button>
                                ` : ''}
                                <button class="btn btn-sm btn-danger" onclick="deletePayment('${doc.id}')">
                                    <i class="fa-solid fa-trash"></i> Excluir
                                </button>
                            </div>
                        `;
                        
                        container.appendChild(paymentItem);
                    });
                    
                } catch (error) {
                    console.error("Erro ao carregar contas a pagar:", error);
                    const container = document.getElementById('paymentList');
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--expense-color);">
                            <i class="fa-solid fa-exclamation-triangle"></i>
                            <p>Erro ao carregar contas a pagar: ${error.message}</p>
                        </div>
                    `;
                }
            };

            window.markAsPaid = async function(paymentId) {
                if (!confirm("Deseja marcar esta conta como paga? Esta a√ß√£o tamb√©m adicionar√° uma despesa correspondente.")) return;
                
                try {
                    const user = window.firebaseAuth.currentUser;
                    if (!user) return;
                    
                    // Obter dados do pagamento
                    const paymentRef = doc(window.firebaseDb, `users/${user.uid}/payments`, paymentId);
                    const paymentDoc = await getDocs(query(collection(window.firebaseDb, `users/${user.uid}/payments`), where("__name__", "==", paymentId)));
                    
                    if (paymentDoc.empty) {
                        alert("Conta n√£o encontrada!");
                        return;
                    }
                    
                    const paymentData = paymentDoc.docs[0].data();
                    
                    // Atualizar status do pagamento para "paid"
                    await updateDoc(paymentRef, {
                        status: 'paid',
                        paidDate: window.getCurrentDate()
                    });
                    
                    // Adicionar como despesa
                    const today = window.getCurrentDate();
                    const dateObj = new Date(today + 'T00:00:00-03:00');
                    const month = dateObj.getUTCMonth() + 1;
                    const year = dateObj.getUTCFullYear();
                    
                    await addDoc(collection(window.firebaseDb, `users/${user.uid}/expenses`), { 
                        item: `${paymentData.item} (Conta Paga)`, 
                        value: paymentData.value, 
                        category: paymentData.category,
                        date: today,
                        month: month,
                        year: year,
                        createdAt: new Date().toISOString(),
                        paymentId: paymentId // Refer√™ncia ao pagamento original
                    });
                    
                    alert("Conta marcada como paga e adicionada √†s despesas!");
                    
                    // Atualizar todas as visualiza√ß√µes
                    loadPayments();
                    sync("expenses", "expensesTable");
                    loadStats();
                    loadModernCharts();
                    updateSmartAlert();
                    
                } catch (error) {
                    alert("Erro ao marcar como pago: " + error.message);
                }
            };

            window.deletePayment = async function(paymentId) {
                if (!confirm("Excluir esta conta a pagar?")) return;
                
                try {
                    await deleteDoc(doc(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/payments`, paymentId));
                    loadPayments();
                } catch (error) {
                    alert("Erro ao excluir conta: " + error.message);
                }
            };

            window.addExpenseGoal = async function() {
                const category = document.getElementById('expenseGoalCategory').value;
                const target = parseFloat(document.getElementById('expenseGoalTarget').value);
                
                if (!category || !target) {
                    alert("Preencha todos os campos!");
                    return;
                }
                
                if (isNaN(target) || target <= 0) {
                    alert("Digite um valor v√°lido para a meta!");
                    return;
                }
                
                try {
                    await addDoc(collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/expenseGoals`), {
                        category,
                        target,
                        month: window.selectedDate.month,
                        year: window.selectedDate.year,
                        createdAt: new Date().toISOString()
                    });
                    
                    document.getElementById('expenseGoalCategory').value = '';
                    document.getElementById('expenseGoalTarget').value = '';
                    alert("Meta de despesa adicionada com sucesso!");
                } catch (error) {
                    alert("Erro ao adicionar meta de despesa: " + error.message);
                }
            };

            window.addIncomeGoal = async function() {
                const category = document.getElementById('incomeGoalCategory').value;
                const target = parseFloat(document.getElementById('incomeGoalTarget').value);
                
                if (!category || !target) {
                    alert("Preencha todos os campos!");
                    return;
                }
                
                if (isNaN(target) || target <= 0) {
                    alert("Digite um valor v√°lido para a meta!");
                    return;
                }
                
                try {
                    await addDoc(collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/incomeGoals`), {
                        category,
                        target,
                        month: window.selectedDate.month,
                        year: window.selectedDate.year,
                        createdAt: new Date().toISOString()
                    });
                    
                    document.getElementById('incomeGoalCategory').value = '';
                    document.getElementById('incomeGoalTarget').value = '';
                    alert("Meta de ganho adicionada com sucesso!");
                } catch (error) {
                    alert("Erro ao adicionar meta de ganho: " + error.message);
                }
            };

            window.deleteCategory = async function(type, categoryId) {
                if (!confirm("Tem certeza que deseja excluir esta categoria?")) return;
                
                try {
                    const collectionName = type === 'expense' ? 'expenseCategories' : 'incomeCategories';
                    await deleteDoc(doc(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/${collectionName}`, categoryId));
                    alert("Categoria exclu√≠da!");
                } catch (error) {
                    alert("Erro ao excluir categoria: " + error.message);
                }
            };

            window.goToDashboard = function() {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById('dashboard').classList.add('active');
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.querySelector('.nav-link[data-page="dashboard"]').classList.add('active');
                closeSidebar();
                closeNotifications();
                loadStats();
                loadModernCharts();
                updateSmartAlert();
            };

            window.closeSidebar = function() {
                document.getElementById('sidebar').classList.remove('expanded');
                document.getElementById('overlay').classList.remove('active');
            };

            window.toggleNotifications = function() {
                const modal = document.getElementById('notificationModal');
                modal.classList.toggle('active');
            };

            function closeNotifications() {
                document.getElementById('notificationModal').classList.remove('active');
            }

            function updateNotificationBadge() {
                const count = window.notifications.length;
                const badge = document.getElementById('notificationCount');
                const icon = document.getElementById('notificationIcon');
                
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'flex';
                    icon.classList.add('has-notifications');
                } else {
                    badge.style.display = 'none';
                    icon.classList.remove('has-notifications');
                }
                
                updateNotificationsList();
            }

            function updateNotificationsList() {
                const list = document.getElementById('notificationsList');
                list.innerHTML = '';
                
                if (window.notifications.length === 0) {
                    list.innerHTML = '<p style="color: var(--text-sub); text-align: center;">Nenhuma notifica√ß√£o</p>';
                    return;
                }
                
                window.notifications.forEach(notification => {
                    const item = document.createElement('div');
                    item.className = 'notification-item';
                    item.innerHTML = `
                        <div class="notification-warning">
                            <i class="fa-solid fa-bell"></i> ${notification.title}
                        </div>
                        <div style="font-size: 0.85rem; margin-top: 5px; color: var(--text-sub);">
                            ${notification.message}
                        </div>
                    `;
                    list.appendChild(item);
                });
            }

            window.addExpense = async function() {
                const item = document.getElementById('expItem').value;
                const value = parseFloat(document.getElementById('expValue').value);
                const category = document.getElementById('expCategory').value;
                const date = document.getElementById('expDate').value || getCurrentDate();
                
                if (!item || !value || !category) {
                    alert("Preencha todos os campos obrigat√≥rios!");
                    return;
                }
                
                if (isNaN(value) || value <= 0) {
                    alert("Digite um valor v√°lido!");
                    return;
                }
                
                try {
                    // Extrai m√™s e ano da data fornecida
                    const dateObj = new Date(date + 'T00:00:00-03:00');
                    const month = dateObj.getUTCMonth() + 1;
                    const year = dateObj.getUTCFullYear();
                    
                    await addDoc(collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/expenses`), { 
                        item, 
                        value, 
                        category,
                        date,
                        month: month,
                        year: year,
                        createdAt: new Date().toISOString()
                    });
                    
                    document.getElementById('expItem').value = ''; 
                    document.getElementById('expValue').value = '';
                    document.getElementById('expCategory').value = '';
                    document.getElementById('expDate').value = getCurrentDate();
                    
                    // CORRE√á√ÉO: For√ßar atualiza√ß√£o da tabela de despesas
                    sync("expenses", "expensesTable");
                    loadStats();
                    loadModernCharts();
                    updateSmartAlert();
                    
                    alert("Despesa registrada com sucesso!");
                } catch (error) {
                    alert("Erro ao registrar despesa: " + error.message);
                }
            };

            window.addIncome = async function() {
                const item = document.getElementById('incItem').value;
                const value = parseFloat(document.getElementById('incValue').value);
                const category = document.getElementById('incCategory').value;
                const date = document.getElementById('incDate').value || getCurrentDate();
                
                if (!item || !value || !category) {
                    alert("Preencha todos os campos obrigat√≥rios!");
                    return;
                }
                
                if (isNaN(value) || value <= 0) {
                    alert("Digite um valor v√°lido!");
                    return;
                }
                
                try {
                    // Extrai m√™s e ano da data fornecida
                    const dateObj = new Date(date + 'T00:00:00-03:00');
                    const month = dateObj.getUTCMonth() + 1;
                    const year = dateObj.getUTCFullYear();
                    
                    await addDoc(collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/income`), { 
                        item, 
                        value, 
                        category,
                        date,
                        month: month,
                        year: year,
                        createdAt: new Date().toISOString()
                    });
                    
                    document.getElementById('incItem').value = ''; 
                    document.getElementById('incValue').value = '';
                    document.getElementById('incCategory').value = '';
                    document.getElementById('incDate').value = getCurrentDate();
                    
                    // CORRE√á√ÉO: For√ßar atualiza√ß√£o da tabela de ganhos
                    sync("income", "incomeTable");
                    loadStats();
                    loadModernCharts();
                    updateSmartAlert();
                    
                    alert("Ganho registrado com sucesso!");
                } catch (error) {
                    alert("Erro ao registrar ganho: " + error.message);
                }
            };

            window.loadStats = async function() {
                if (!window.firebaseAuth.currentUser) return;
                
                try {
                    const expensesRef = collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/expenses`);
                    const currentExpensesQuery = query(
                        expensesRef,
                        where("month", "==", window.selectedDate.month),
                        where("year", "==", window.selectedDate.year)
                    );
                    const currentExpensesSnapshot = await getDocs(currentExpensesQuery);
                    
                    let currentExpenses = 0;
                    currentExpensesSnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.value && typeof data.value === 'number') {
                            currentExpenses += data.value;
                        }
                    });
                    
                    const prevMonth = window.selectedDate.month === 1 ? 12 : window.selectedDate.month - 1;
                    const prevYear = window.selectedDate.month === 1 ? window.selectedDate.year - 1 : window.selectedDate.year;
                    
                    const prevExpensesQuery = query(
                        expensesRef,
                        where("month", "==", prevMonth),
                        where("year", "==", prevYear)
                    );
                    const prevExpensesSnapshot = await getDocs(prevExpensesQuery);
                    
                    let prevExpenses = 0;
                    prevExpensesSnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.value && typeof data.value === 'number') {
                            prevExpenses += data.value;
                        }
                    });
                    
                    const incomeRef = collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/income`);
                    const currentIncomeQuery = query(
                        incomeRef,
                        where("month", "==", window.selectedDate.month),
                        where("year", "==", window.selectedDate.year)
                    );
                    const currentIncomeSnapshot = await getDocs(currentIncomeQuery);
                    
                    let currentIncome = 0;
                    currentIncomeSnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.value && typeof data.value === 'number') {
                            currentIncome += data.value;
                        }
                    });
                    
                    const prevIncomeQuery = query(
                        incomeRef,
                        where("month", "==", prevMonth),
                        where("year", "==", prevYear)
                    );
                    const prevIncomeSnapshot = await getDocs(prevIncomeQuery);
                    
                    let prevIncome = 0;
                    prevIncomeSnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.value && typeof data.value === 'number') {
                            prevIncome += data.value;
                        }
                    });
                    
                    const currentBalance = currentIncome - currentExpenses;
                    const prevBalance = prevIncome - prevExpenses;
                    
                    const expenseChange = prevExpenses > 0 ? ((currentExpenses - prevExpenses) / prevExpenses * 100) : 0;
                    const incomeChange = prevIncome > 0 ? ((currentIncome - prevIncome) / prevIncome * 100) : 0;
                    const balanceChange = prevBalance !== 0 ? ((currentBalance - prevBalance) / Math.abs(prevBalance) * 100) : 0;
                    
                    document.getElementById('totalExpenses').textContent = formatCurrency(currentExpenses);
                    document.getElementById('totalIncome').textContent = formatCurrency(currentIncome);
                    document.getElementById('monthBalance').textContent = formatCurrency(currentBalance);
                    
                    const expenseChangeEl = document.getElementById('expenseChange');
                    expenseChangeEl.innerHTML = `<i class="fa-solid fa-arrow-${expenseChange >= 0 ? 'up' : 'down'}"></i> ${Math.abs(expenseChange).toFixed(1)}%`;
                    expenseChangeEl.className = `stat-change ${expenseChange >= 0 ? 'negative' : ''}`;
                    
                    const incomeChangeEl = document.getElementById('incomeChange');
                    incomeChangeEl.innerHTML = `<i class="fa-solid fa-arrow-${incomeChange >= 0 ? 'up' : 'down'}"></i> ${Math.abs(incomeChange).toFixed(1)}%`;
                    
                    const balanceChangeEl = document.getElementById('balanceChange');
                    balanceChangeEl.innerHTML = `<i class="fa-solid fa-arrow-${balanceChange >= 0 ? 'up' : 'down'}"></i> ${Math.abs(balanceChange).toFixed(1)}%`;
                    balanceChangeEl.className = `stat-change ${balanceChange >= 0 ? '' : 'negative'}`;
                    
                    const predictedBalance = currentBalance * 1.1;
                    document.getElementById('predictedBalance').textContent = formatCurrency(predictedBalance);
                    
                    document.getElementById('incomeTrend').textContent = (incomeChange >= 0 ? '+' : '') + incomeChange.toFixed(1) + '%';
                    document.getElementById('expenseTrend').textContent = (expenseChange >= 0 ? '+' : '') + expenseChange.toFixed(1) + '%';
                    
                } catch (error) {
                    console.error("Erro ao carregar estat√≠sticas:", error);
                }
            };

            window.loadGoals = async function() {
                if (!window.firebaseAuth.currentUser) return;
                
                const expenseGoalsRef = collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/expenseGoals`);
                const expenseGoalsQuery = query(
                    expenseGoalsRef, 
                    where("month", "==", window.selectedDate.month),
                    where("year", "==", window.selectedDate.year)
                );
                
                onSnapshot(expenseGoalsQuery, async (snapshot) => {
                    const container = document.getElementById('expenseGoalsList');
                    container.innerHTML = '';
                    
                    snapshot.forEach(doc => {
                        const goal = doc.data();
                        
                        calculateCurrentExpense(goal.category).then(currentAmount => {
                            const progress = currentAmount > 0 ? Math.min((currentAmount / goal.target) * 100, 100) : 0;
                            
                            const goalCard = document.createElement('div');
                            goalCard.className = 'goal-card';
                            goalCard.innerHTML = `
                                <div class="goal-header">
                                    <div>
                                        <strong>${goal.category}</strong>
                                        <div style="font-size: 0.9rem; color: var(--text-sub); margin-top: 5px;">
                                            Meta: ${formatCurrency(goal.target)} | Atual: ${formatCurrency(currentAmount)}
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-danger" onclick="deleteGoal('expense', '${doc.id}')">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                                <div class="goal-progress">
                                    <div class="goal-progress-bar" style="width: ${progress}%"></div>
                                </div>
                                <div style="font-size: 0.85rem; color: var(--text-sub); margin-top: 5px; text-align: right;">
                                    ${progress.toFixed(1)}% ${progress >= 100 ? '‚úÖ Meta atingida!' : ''}
                                </div>
                            `;
                            container.appendChild(goalCard);
                        });
                    });
                    
                    if (snapshot.empty) {
                        container.innerHTML = '<p style="color: var(--text-sub); text-align: center;">Nenhuma meta de despesa definida para este m√™s</p>';
                    }
                    
                    updateSmartAlert();
                });
                
                const incomeGoalsRef = collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/incomeGoals`);
                const incomeGoalsQuery = query(
                    incomeGoalsRef, 
                    where("month", "==", window.selectedDate.month),
                    where("year", "==", window.selectedDate.year)
                );
                
                onSnapshot(incomeGoalsQuery, async (snapshot) => {
                    const container = document.getElementById('incomeGoalsList');
                    container.innerHTML = '';
                    
                    snapshot.forEach(doc => {
                        const goal = doc.data();
                        
                        calculateCurrentIncome(goal.category).then(currentAmount => {
                            const progress = currentAmount > 0 ? Math.min((currentAmount / goal.target) * 100, 100) : 0;
                            
                            const goalCard = document.createElement('div');
                            goalCard.className = 'goal-card income-goal';
                            goalCard.innerHTML = `
                                <div class="goal-header">
                                    <div>
                                        <strong>${goal.category}</strong>
                                        <div style="font-size: 0.9rem; color: var(--text-sub); margin-top: 5px;">
                                            Meta: ${formatCurrency(goal.target)} | Atual: ${formatCurrency(currentAmount)}
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-danger" onclick="deleteGoal('income', '${doc.id}')">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                                <div class="goal-progress">
                                    <div class="goal-progress-bar" style="width: ${progress}%"></div>
                                </div>
                                <div style="font-size: 0.85rem; color: var(--text-sub); margin-top: 5px; text-align: right;">
                                    ${progress.toFixed(1)}% ${progress >= 100 ? '‚úÖ Meta atingida!' : ''}
                                </div>
                            `;
                            container.appendChild(goalCard);
                        });
                    });
                    
                    if (snapshot.empty) {
                        container.innerHTML = '<p style="color: var(--text-sub); text-align: center;">Nenhuma meta de ganho definida para este m√™s</p>';
                    }
                });
            };

            async function calculateCurrentExpense(category) {
                if (!window.firebaseAuth.currentUser) return 0;
                
                const expensesRef = collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/expenses`);
                const q = query(
                    expensesRef,
                    where("month", "==", window.selectedDate.month),
                    where("year", "==", window.selectedDate.year),
                    where("category", "==", category)
                );
                
                try {
                    const snapshot = await getDocs(q);
                    let total = 0;
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.value && typeof data.value === 'number') {
                            total += data.value;
                        }
                    });
                    return total;
                } catch (error) {
                    console.error("Erro ao calcular despesas:", error);
                    return 0;
                }
            };

            async function calculateCurrentIncome(category) {
                if (!window.firebaseAuth.currentUser) return 0;
                
                const incomeRef = collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/income`);
                const q = query(
                    incomeRef,
                    where("month", "==", window.selectedDate.month),
                    where("year", "==", window.selectedDate.year),
                    where("category", "==", category)
                );
                
                try {
                    const snapshot = await getDocs(q);
                    let total = 0;
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.value && typeof data.value === 'number') {
                            total += data.value;
                        }
                    });
                    return total;
                } catch (error) {
                    console.error("Erro ao calcular ganhos:", error);
                    return 0;
                }
            };

            async function updateSmartAlert() {
                if (!window.firebaseAuth.currentUser) return;
                
                try {
                    const expenseGoalsRef = collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/expenseGoals`);
                    const expenseGoalsQuery = query(
                        expenseGoalsRef,
                        where("month", "==", window.selectedDate.month),
                        where("year", "==", window.selectedDate.year)
                    );
                    
                    const snapshot = await getDocs(expenseGoalsQuery);
                    
                    if (snapshot.empty) {
                        document.getElementById('smartAlertText').innerHTML = 'Nenhuma meta de despesa definida para este m√™s.';
                        document.getElementById('smartAlertContainer').style.background = 'rgba(16, 185, 129, 0.1)';
                        return;
                    }
                    
                    let highestRatio = 0;
                    let alertCategory = '';
                    let alertCurrent = 0;
                    let alertTarget = 0;
                    
                    for (const doc of snapshot.docs) {
                        const goal = doc.data();
                        const currentExpense = await calculateCurrentExpense(goal.category);
                        const ratio = goal.target > 0 ? (currentExpense / goal.target) * 100 : 0;
                        
                        if (ratio > highestRatio) {
                            highestRatio = ratio;
                            alertCategory = goal.category;
                            alertCurrent = currentExpense;
                            alertTarget = goal.target;
                        }
                    }
                    
                    const alertContainer = document.getElementById('smartAlertContainer');
                    const alertText = document.getElementById('smartAlertText');
                    
                    if (highestRatio >= 100) {
                        alertText.innerHTML = `‚ö†Ô∏è <strong>"${alertCategory}"</strong> ultrapassou a meta em ${(highestRatio - 100).toFixed(1)}%! Gasto: ${formatCurrency(alertCurrent)} | Meta: ${formatCurrency(alertTarget)}`;
                        alertContainer.style.background = 'rgba(244, 63, 94, 0.1)';
                    } else if (highestRatio >= 80) {
                        alertText.innerHTML = `‚ö†Ô∏è <strong>"${alertCategory}"</strong> est√° pr√≥ximo da meta (${highestRatio.toFixed(1)}%). Gasto: ${formatCurrency(alertCurrent)} | Meta: ${formatCurrency(alertTarget)}`;
                        alertContainer.style.background = 'rgba(245, 158, 11, 0.1)';
                    } else if (highestRatio > 0) {
                        alertText.innerHTML = `‚úÖ <strong>"${alertCategory}"</strong> tem a maior utiliza√ß√£o (${highestRatio.toFixed(1)}%). Gasto: ${formatCurrency(alertCurrent)} | Meta: ${formatCurrency(alertTarget)}`;
                        alertContainer.style.background = 'rgba(16, 185, 129, 0.1)';
                    } else {
                        alertText.innerHTML = 'Todas as metas est√£o dentro do limite. Continue assim!';
                        alertContainer.style.background = 'rgba(16, 185, 129, 0.1)';
                    }
                    
                } catch (error) {
                    console.error("Erro ao atualizar alerta inteligente:", error);
                    document.getElementById('smartAlertText').innerHTML = 'Erro ao carregar alertas.';
                }
            }

            window.deleteGoal = async function(type, goalId) {
                if (!confirm("Tem certeza que deseja excluir esta meta?")) return;
                
                try {
                    const collectionName = type === 'expense' ? 'expenseGoals' : 'incomeGoals';
                    await deleteDoc(doc(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/${collectionName}`, goalId));
                    alert("Meta exclu√≠da!");
                    window.loadGoals();
                    window.loadModernCharts();
                    window.updateSmartAlert();
                } catch (error) {
                    alert("Erro ao excluir meta: " + error.message);
                }
            };

            window.loadModernCharts = async function() {
                if (!window.firebaseAuth.currentUser) return;
                
                try {
                    await loadExpensesVsGoalsChart();
                    await loadExpenseDoughnutChart();
                    await loadEvolutionAreaChart();
                    await loadTopCategoriesChart();
                } catch (error) {
                    console.error("Erro ao carregar gr√°ficos modernos:", error);
                }
            };

            async function loadExpensesVsGoalsChart() {
                if (!window.firebaseAuth.currentUser) return;
                
                try {
                    const expenseGoalsRef = collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/expenseGoals`);
                    const expenseGoalsQuery = query(
                        expenseGoalsRef,
                        where("month", "==", window.selectedDate.month),
                        where("year", "==", window.selectedDate.year)
                    );
                    
                    const goalsSnapshot = await getDocs(expenseGoalsQuery);
                    
                    if (goalsSnapshot.empty) {
                        document.getElementById('noExpenseGoalDataMessage').style.display = 'block';
                        const canvas = document.getElementById('expensesVsGoalsChart');
                        if (canvas) canvas.style.display = 'none';
                        
                        if (window.expensesVsGoalsChart) {
                            window.expensesVsGoalsChart.destroy();
                            window.expensesVsGoalsChart = null;
                        }
                        return;
                    }
                    
                    document.getElementById('noExpenseGoalDataMessage').style.display = 'none';
                    const canvas = document.getElementById('expensesVsGoalsChart');
                    if (canvas) canvas.style.display = 'block';
                    
                    const categories = [];
                    const expensesData = [];
                    const goalsData = [];
                    const percentageData = [];
                    
                    for (const doc of goalsSnapshot.docs) {
                        const goal = doc.data();
                        const currentExpense = await calculateCurrentExpense(goal.category);
                        
                        categories.push(goal.category);
                        expensesData.push(currentExpense);
                        goalsData.push(goal.target);
                        
                        const percentage = goal.target > 0 ? (currentExpense / goal.target) * 100 : 0;
                        percentageData.push(percentage);
                    }
                    
                    const ctx = document.getElementById('expensesVsGoalsChart').getContext('2d');
                    
                    if (window.expensesVsGoalsChart) {
                        window.expensesVsGoalsChart.destroy();
                    }
                    
                    const expenseColor = 'rgba(244, 63, 94, 0.8)';
                    const goalColor = 'rgba(79, 70, 229, 0.8)';
                    const expenseBorder = '#f43f5e';
                    const goalBorder = '#4f46e5';
                    
                    window.expensesVsGoalsChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: categories,
                            datasets: [
                                {
                                    label: 'Despesas Atuais',
                                    data: expensesData,
                                    backgroundColor: expenseColor,
                                    borderColor: expenseBorder,
                                    borderWidth: 2,
                                    borderRadius: 6,
                                    borderSkipped: false
                                },
                                {
                                    label: 'Meta',
                                    data: goalsData,
                                    backgroundColor: goalColor,
                                    borderColor: goalBorder,
                                    borderWidth: 2,
                                    borderRadius: 6,
                                    borderSkipped: false
                                }
                            ]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        color: 'var(--text-sub)',
                                        usePointStyle: true,
                                        pointStyle: 'circle'
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.dataset.label || '';
                                            const value = context.raw;
                                            const percentage = percentageData[context.dataIndex];
                                            
                                            if (label === 'Despesas Atuais') {
                                                return `${label}: ${formatCurrency(value)} (${percentage.toFixed(1)}% da meta)`;
                                            }
                                            return `${label}: ${formatCurrency(value)}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    ticks: {
                                        color: 'var(--text-sub)',
                                        callback: function(value) {
                                            return 'R$ ' + value.toLocaleString('pt-BR');
                                        }
                                    }
                                },
                                y: {
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    ticks: {
                                        color: 'var(--text-sub)'
                                    }
                                }
                            },
                            animation: {
                                duration: 1500,
                                easing: 'easeOutQuart'
                            }
                        }
                    });
                    
                } catch (error) {
                    console.error("Erro ao carregar gr√°fico Despesas vs Metas:", error);
                    document.getElementById('noExpenseGoalDataMessage').style.display = 'block';
                    const canvas = document.getElementById('expensesVsGoalsChart');
                    if (canvas) canvas.style.display = 'none';
                }
            }

            async function loadExpenseDoughnutChart() {
                if (!window.firebaseAuth.currentUser) return;
                
                try {
                    const expensesRef = collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/expenses`);
                    const expensesQuery = query(
                        expensesRef,
                        where("month", "==", window.selectedDate.month),
                        where("year", "==", window.selectedDate.year)
                    );
                    const snapshot = await getDocs(expensesQuery);
                    
                    const categoryTotals = {};
                    let totalExpenses = 0;
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.category && data.value) {
                            if (!categoryTotals[data.category]) {
                                categoryTotals[data.category] = 0;
                            }
                            categoryTotals[data.category] += data.value;
                            totalExpenses += data.value;
                        }
                    });
                    
                    const sortedCategories = Object.entries(categoryTotals)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 8);
                    
                    const ctx = document.getElementById('expenseDoughnutChart');
                    if (!ctx) return;
                    
                    const canvasCtx = ctx.getContext('2d');
                    
                    if (window.expenseDoughnutChart) {
                        window.expenseDoughnutChart.destroy();
                    }
                    
                    if (sortedCategories.length === 0) {
                        document.getElementById('noExpenseDataMessage').style.display = 'block';
                        ctx.style.display = 'none';
                        return;
                    }
                    
                    document.getElementById('noExpenseDataMessage').style.display = 'none';
                    ctx.style.display = 'block';
                    
                    const gradients = [
                        canvasCtx.createLinearGradient(0, 0, 0, 400),
                        canvasCtx.createLinearGradient(0, 0, 0, 400),
                        canvasCtx.createLinearGradient(0, 0, 0, 400),
                        canvasCtx.createLinearGradient(0, 0, 0, 400),
                        canvasCtx.createLinearGradient(0, 0, 0, 400),
                        canvasCtx.createLinearGradient(0, 0, 0, 400),
                        canvasCtx.createLinearGradient(0, 0, 0, 400),
                        canvasCtx.createLinearGradient(0, 0, 0, 400)
                    ];
                    
                    const colors = [
                        ['#f43f5e', '#e11d48'],
                        ['#8b5cf6', '#7c3aed'],
                        ['#0ea5e9', '#0284c7'],
                        ['#10b981', '#059669'],
                        ['#f59e0b', '#d97706'],
                        ['#ec4899', '#db2777'],
                        ['#14b8a6', '#0d9488'],
                        ['#84cc16', '#65a30d']
                    ];
                    
                    gradients.forEach((gradient, i) => {
                        if (colors[i]) {
                            gradient.addColorStop(0, colors[i][0]);
                            gradient.addColorStop(1, colors[i][1]);
                        }
                    });
                    
                    window.expenseDoughnutChart = new Chart(canvasCtx, {
                        type: 'doughnut',
                        data: {
                            labels: sortedCategories.map(item => item[0]),
                            datasets: [{
                                data: sortedCategories.map(item => item[1]),
                                backgroundColor: gradients.slice(0, sortedCategories.length),
                                borderColor: 'var(--bg-card)',
                                borderWidth: 3,
                                hoverBorderWidth: 5,
                                hoverOffset: 15
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '70%',
                            plugins: {
                                legend: {
                                    position: 'right',
                                    labels: {
                                        color: 'var(--text-sub)',
                                        padding: 20,
                                        usePointStyle: true,
                                        pointStyle: 'circle'
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.raw;
                                            const percentage = ((value / totalExpenses) * 100).toFixed(1);
                                            return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
                                        }
                                    }
                                }
                            },
                            animation: {
                                animateScale: true,
                                animateRotate: true,
                                duration: 2000,
                                easing: 'easeOutQuart'
                            }
                        }
                    });
                    
                } catch (error) {
                    console.error("Erro ao carregar gr√°fico de doughnut:", error);
                    const msg = document.getElementById('noExpenseDataMessage');
                    const chart = document.getElementById('expenseDoughnutChart');
                    if (msg) msg.style.display = 'block';
                    if (chart) chart.style.display = 'none';
                }
            }

            async function loadEvolutionAreaChart() {
                if (!window.firebaseAuth.currentUser) return;
                
                try {
                    const monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                    const months = [];
                    const expensesData = [];
                    const incomeData = [];
                    const balanceData = [];
                    
                    // Pega os √∫ltimos 6 meses em rela√ß√£o ao m√™s selecionado
                    for (let i = 5; i >= 0; i--) {
                        const date = new Date(window.selectedDate.year, window.selectedDate.month - 1 - i, 1);
                        const month = date.getMonth() + 1;
                        const year = date.getFullYear();
                        const monthName = `${monthNames[date.getMonth()]}/${date.getFullYear().toString().slice(-2)}`;
                        
                        months.push(monthName);
                        
                        const expensesRef = collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/expenses`);
                        const expensesQuery = query(
                            expensesRef,
                            where("month", "==", month),
                            where("year", "==", year)
                        );
                        const expensesSnapshot = await getDocs(expensesQuery);
                        let expensesTotal = 0;
                        expensesSnapshot.forEach(doc => {
                            const data = doc.data();
                            if (data.value) expensesTotal += data.value;
                        });
                        expensesData.push(expensesTotal);
                        
                        const incomeRef = collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/income`);
                        const incomeQuery = query(
                            incomeRef,
                            where("month", "==", month),
                            where("year", "==", year)
                        );
                        const incomeSnapshot = await getDocs(incomeQuery);
                        let incomeTotal = 0;
                        incomeSnapshot.forEach(doc => {
                            const data = doc.data();
                            if (data.value) incomeTotal += data.value;
                        });
                        incomeData.push(incomeTotal);
                        
                        balanceData.push(incomeTotal - expensesTotal);
                    }
                    
                    const ctx = document.getElementById('evolutionAreaChart');
                    if (!ctx) return;
                    
                    const canvasCtx = ctx.getContext('2d');
                    
                    if (window.evolutionAreaChart) {
                        window.evolutionAreaChart.destroy();
                    }
                    
                    const hasData = expensesData.some(val => val > 0) || incomeData.some(val => val > 0);
                    
                    if (!hasData) {
                        document.getElementById('noEvolutionDataMessage').style.display = 'block';
                        ctx.style.display = 'none';
                        return;
                    }
                    
                    document.getElementById('noEvolutionDataMessage').style.display = 'none';
                    ctx.style.display = 'block';
                    
                    const expenseGradient = canvasCtx.createLinearGradient(0, 0, 0, 400);
                    expenseGradient.addColorStop(0, 'rgba(244, 63, 94, 0.6)');
                    expenseGradient.addColorStop(1, 'rgba(244, 63, 94, 0.1)');
                    
                    const incomeGradient = canvasCtx.createLinearGradient(0, 0, 0, 400);
                    incomeGradient.addColorStop(0, 'rgba(16, 185, 129, 0.6)');
                    incomeGradient.addColorStop(1, 'rgba(16, 185, 129, 0.1)');
                    
                    window.evolutionAreaChart = new Chart(canvasCtx, {
                        type: 'line',
                        data: {
                            labels: months,
                            datasets: [
                                {
                                    label: 'Despesas',
                                    data: expensesData,
                                    borderColor: '#f43f5e',
                                    backgroundColor: expenseGradient,
                                    borderWidth: 3,
                                    tension: 0.4,
                                    fill: true,
                                    pointBackgroundColor: '#f43f5e',
                                    pointBorderColor: '#fff',
                                    pointRadius: 4,
                                    pointHoverRadius: 6
                                },
                                {
                                    label: 'Ganhos',
                                    data: incomeData,
                                    borderColor: '#10b981',
                                    backgroundColor: incomeGradient,
                                    borderWidth: 3,
                                    tension: 0.4,
                                    fill: true,
                                    pointBackgroundColor: '#10b981',
                                    pointBorderColor: '#fff',
                                    pointRadius: 4,
                                    pointHoverRadius: 6
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        color: 'var(--text-sub)',
                                        usePointStyle: true,
                                        pointStyle: 'circle'
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    ticks: {
                                        color: 'var(--text-sub)'
                                    }
                                },
                                y: {
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    ticks: {
                                        color: 'var(--text-sub)',
                                        callback: function(value) {
                                            return 'R$ ' + value.toLocaleString('pt-BR');
                                        }
                                    },
                                    beginAtZero: true
                                }
                            },
                            animation: {
                                duration: 2000,
                                easing: 'easeOutQuart'
                            }
                        }
                    });
                    
                } catch (error) {
                    console.error("Erro ao carregar gr√°fico de √°rea:", error);
                    const msg = document.getElementById('noEvolutionDataMessage');
                    const chart = document.getElementById('evolutionAreaChart');
                    if (msg) msg.style.display = 'block';
                    if (chart) chart.style.display = 'none';
                }
            }

            async function loadTopCategoriesChart() {
                if (!window.firebaseAuth.currentUser) return;
                
                try {
                    const expensesRef = collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/expenses`);
                    const expensesQuery = query(
                        expensesRef,
                        where("month", "==", window.selectedDate.month),
                        where("year", "==", window.selectedDate.year)
                    );
                    const snapshot = await getDocs(expensesQuery);
                    
                    const categoryTotals = {};
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.category && data.value) {
                            if (!categoryTotals[data.category]) {
                                categoryTotals[data.category] = 0;
                            }
                            categoryTotals[data.category] += data.value;
                        }
                    });
                    
                    // Alterado para 5 categorias (ao inv√©s de 7)
                    const sortedCategories = Object.entries(categoryTotals)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5);
                    
                    const ctx = document.getElementById('topCategoriesChart');
                    if (!ctx) return;
                    
                    const canvasCtx = ctx.getContext('2d');
                    
                    if (window.topCategoriesChart) {
                        window.topCategoriesChart.destroy();
                    }
                    
                    if (sortedCategories.length === 0) {
                        document.getElementById('noCategoriesDataMessage').style.display = 'block';
                        ctx.style.display = 'none';
                        return;
                    }
                    
                    document.getElementById('noCategoriesDataMessage').style.display = 'none';
                    ctx.style.display = 'block';
                    
                    const barGradient = canvasCtx.createLinearGradient(0, 0, 400, 0);
                    barGradient.addColorStop(0, 'rgba(245, 158, 11, 0.8)');
                    barGradient.addColorStop(1, 'rgba(245, 158, 11, 0.4)');
                    
                    window.topCategoriesChart = new Chart(canvasCtx, {
                        type: 'bar',
                        data: {
                            labels: sortedCategories.map(item => item[0]),
                            datasets: [{
                                label: 'Valor Gasto',
                                data: sortedCategories.map(item => item[1]),
                                backgroundColor: barGradient,
                                borderColor: 'rgba(245, 158, 11, 1)',
                                borderWidth: 1,
                                borderRadius: 8,
                                borderSkipped: false
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `Gasto: ${formatCurrency(context.raw)}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    ticks: {
                                        color: 'var(--text-sub)',
                                        callback: function(value) {
                                            return 'R$ ' + value.toLocaleString('pt-BR');
                                        }
                                    },
                                    beginAtZero: true
                                },
                                y: {
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    ticks: {
                                        color: 'var(--text-sub)'
                                    }
                                }
                            },
                            animation: {
                                duration: 2000,
                                easing: 'easeOutQuart'
                            }
                        }
                    });
                    
                } catch (error) {
                    console.error("Erro ao carregar gr√°fico de categorias:", error);
                    const msg = document.getElementById('noCategoriesDataMessage');
                    const chart = document.getElementById('topCategoriesChart');
                    if (msg) msg.style.display = 'block';
                    if (chart) chart.style.display = 'none';
                }
            }

            window.exportToExcel = async function() {
                if (!window.firebaseAuth.currentUser) return;
                
                try {
                    const data = {
                        expenses: [],
                        income: [],
                        payments: [],
                        expenseCategories: [],
                        incomeCategories: [],
                        expenseGoals: [],
                        incomeGoals: [],
                        exportDate: new Date().toISOString(),
                        exportUser: window.firebaseAuth.currentUser.email
                    };
                    
                    const expensesSnapshot = await getDocs(collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/expenses`));
                    expensesSnapshot.forEach(doc => data.expenses.push({ id: doc.id, ...doc.data() }));
                    
                    const incomeSnapshot = await getDocs(collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/income`));
                    incomeSnapshot.forEach(doc => data.income.push({ id: doc.id, ...doc.data() }));
                    
                    const paymentsSnapshot = await getDocs(collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/payments`));
                    paymentsSnapshot.forEach(doc => data.payments.push({ id: doc.id, ...doc.data() }));
                    
                    const expenseCatSnapshot = await getDocs(collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/expenseCategories`));
                    expenseCatSnapshot.forEach(doc => data.expenseCategories.push({ id: doc.id, ...doc.data() }));
                    
                    const incomeCatSnapshot = await getDocs(collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/incomeCategories`));
                    incomeCatSnapshot.forEach(doc => data.incomeCategories.push({ id: doc.id, ...doc.data() }));
                    
                    const expenseGoalsSnapshot = await getDocs(collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/expenseGoals`));
                    expenseGoalsSnapshot.forEach(doc => data.expenseGoals.push({ id: doc.id, ...doc.data() }));
                    
                    const incomeGoalsSnapshot = await getDocs(collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/incomeGoals`));
                    incomeGoalsSnapshot.forEach(doc => data.incomeGoals.push({ id: doc.id, ...doc.data() }));
                    
                    const jsonString = JSON.stringify(data, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `backup_financeiro_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    alert("Backup exportado com sucesso!");
                } catch (error) {
                    alert("Erro ao exportar backup: " + error.message);
                }
            };

            window.openImportModal = function() {
                document.getElementById('importModal').classList.add('active');
            };

            window.closeImportModal = function() {
                document.getElementById('importModal').classList.remove('active');
                document.getElementById('importFile').value = '';
            };

            window.processImport = async function() {
                const fileInput = document.getElementById('importFile');
                const importType = document.getElementById('importType').value;
                
                if (!fileInput.files[0]) {
                    alert("Selecione um arquivo para importar!");
                    return;
                }
                
                if (!confirm(`Deseja importar dados de ${importType}? Isso pode adicionar registros duplicados.`)) return;
                
                try {
                    const file = fileInput.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = async function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            await importData(data, importType);
                        } catch (error) {
                            alert("Erro ao ler arquivo JSON: " + error.message);
                        }
                    };
                    
                    reader.readAsText(file);
                } catch (error) {
                    alert("Erro ao importar dados: " + error.message);
                }
            };

            async function importData(data, type) {
                if (!window.firebaseAuth.currentUser) return;
                
                try {
                    const batch = writeBatch(window.firebaseDb);
                    let importedCount = 0;
                    
                    let items = [];
                    let collectionName = '';
                    
                    switch(type) {
                        case 'expenses':
                            items = data.expenses || [];
                            collectionName = 'expenses';
                            break;
                        case 'income':
                            items = data.income || [];
                            collectionName = 'income';
                            break;
                        case 'payments':
                            items = data.payments || [];
                            collectionName = 'payments';
                            break;
                        case 'expenseCategories':
                            items = data.expenseCategories || [];
                            collectionName = 'expenseCategories';
                            break;
                        case 'incomeCategories':
                            items = data.incomeCategories || [];
                            collectionName = 'incomeCategories';
                            break;
                    }
                    
                    for (const item of items) {
                        const { id, ...itemData } = item;
                        const docRef = doc(collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/${collectionName}`));
                        batch.set(docRef, {
                            ...itemData,
                            importedAt: new Date().toISOString()
                        });
                        importedCount++;
                    }
                    
                    await batch.commit();
                    closeImportModal();
                    alert(`${importedCount} registros importados com sucesso para ${type}!`);
                    
                    loadStats();
                    loadModernCharts();
                    updateSmartAlert();
                    loadPayments();
                    
                } catch (error) {
                    alert("Erro ao importar dados: " + error.message);
                }
            }

            window.deleteData = async (path, id) => {
                if (confirm("Eliminar registo?")) {
                    await deleteDoc(doc(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/${path}`, id));
                    loadStats();
                    loadModernCharts();
                    updateSmartAlert();
                }
            };

            // CORRE√á√ÉO PRINCIPAL: Fun√ß√£o sync simplificada para evitar erro de √≠ndice
            function sync(path, tableId) {
                if (!window.firebaseAuth.currentUser) return;
                
                // Primeiro, obtemos todos os registros sem filtro complexo
                const q = query(
                    collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/${path}`),
                    orderBy("date", "desc")  // Apenas ordena√ß√£o
                );
                
                onSnapshot(q, (snap) => {
                    const tbody = document.getElementById(tableId);
                    if (!tbody) return;
                    
                    tbody.innerHTML = '';
                    let total = 0;
                    let hasRecordsForMonth = false;
                    
                    // Filtrar localmente por m√™s e ano
                    snap.forEach(d => {
                        const data = d.data();
                        if (!data.date) return;
                        
                        // Verifica se o registro √© do m√™s selecionado
                        const dateObj = new Date(data.date + 'T00:00:00-03:00');
                        const recordMonth = dateObj.getUTCMonth() + 1;
                        const recordYear = dateObj.getUTCFullYear();
                        
                        // Verifica tamb√©m se h√° campos month/year diretamente
                        const dataMonth = data.month || recordMonth;
                        const dataYear = data.year || recordYear;
                        
                        if (dataMonth === window.selectedDate.month && dataYear === window.selectedDate.year) {
                            hasRecordsForMonth = true;
                            const value = parseFloat(data.value) || 0;
                            total += value;
                            
                            tbody.innerHTML += `<tr>
                                <td>${data.item || ''}</td>
                                <td><span class="category-badge">${data.category || 'Sem categoria'}</span></td>
                                <td class="amount ${path === 'expenses' ? 'expense' : 'income'}">${formatCurrency(value)}</td>
                                <td>${data.date ? new Date(data.date + 'T00:00:00-03:00').toLocaleDateString('pt-BR') : 'N/A'}</td>
                                <td><button onclick="deleteData('${path}', '${d.id}')" class="btn btn-sm btn-danger"><i class="fa-solid fa-trash"></i></button></td>
                            </tr>`;
                        }
                    });
                    
                    if (total > 0) {
                        tbody.innerHTML += `<tr style="background: rgba(255, 255, 255, 0.03);">
                            <td><strong>Total</strong></td>
                            <td></td>
                            <td class="amount ${path === 'expenses' ? 'expense' : 'income'}"><strong>${formatCurrency(total)}</strong></td>
                            <td colspan="2"></td>
                        </tr>`;
                    } else if (!hasRecordsForMonth) {
                        tbody.innerHTML = `<tr>
                            <td colspan="5" style="text-align: center; color: var(--text-sub); padding: 40px;">
                                <i class="fa-solid fa-inbox" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                                <p>Nenhum registro encontrado para ${window.selectedDate.month.toString().padStart(2, '0')}/${window.selectedDate.year}</p>
                            </td>
                        </tr>`;
                    }
                }, (error) => {
                    console.error("Erro ao sincronizar dados:", error);
                    
                    // Se for erro de √≠ndice, tenta uma query mais simples
                    if (error.code === 'failed-precondition' || error.message.includes('index')) {
                        console.log("Tentando query alternativa...");
                        // Tenta uma query mais simples sem ordena√ß√£o
                        const simpleQ = query(
                            collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/${path}`)
                        );
                        
                        onSnapshot(simpleQ, (snap) => {
                            const tbody = document.getElementById(tableId);
                            if (!tbody) return;
                            
                            tbody.innerHTML = '';
                            let total = 0;
                            let records = [];
                            
                            snap.forEach(d => {
                                const data = d.data();
                                records.push({ id: d.id, data: data });
                            });
                            
                            // Ordenar localmente por data (mais recente primeiro)
                            records.sort((a, b) => {
                                const dateA = new Date(a.data.date || 0);
                                const dateB = new Date(b.data.date || 0);
                                return dateB - dateA;
                            });
                            
                            // Filtrar por m√™s/ano
                            records.forEach(record => {
                                const data = record.data;
                                if (!data.date) return;
                                
                                const dateObj = new Date(data.date + 'T00:00:00-03:00');
                                const recordMonth = dateObj.getUTCMonth() + 1;
                                const recordYear = dateObj.getUTCFullYear();
                                const dataMonth = data.month || recordMonth;
                                const dataYear = data.year || recordYear;
                                
                                if (dataMonth === window.selectedDate.month && dataYear === window.selectedDate.year) {
                                    const value = parseFloat(data.value) || 0;
                                    total += value;
                                    
                                    tbody.innerHTML += `<tr>
                                        <td>${data.item || ''}</td>
                                        <td><span class="category-badge">${data.category || 'Sem categoria'}</span></td>
                                        <td class="amount ${path === 'expenses' ? 'expense' : 'income'}">${formatCurrency(value)}</td>
                                        <td>${data.date ? new Date(data.date + 'T00:00:00-03:00').toLocaleDateString('pt-BR') : 'N/A'}</td>
                                        <td><button onclick="deleteData('${path}', '${record.id}')" class="btn btn-sm btn-danger"><i class="fa-solid fa-trash"></i></button></td>
                                    </tr>`;
                                }
                            });
                            
                            if (total > 0) {
                                tbody.innerHTML += `<tr style="background: rgba(255, 255, 255, 0.03);">
                                    <td><strong>Total</strong></td>
                                    <td></td>
                                    <td class="amount ${path === 'expenses' ? 'expense' : 'income'}"><strong>${formatCurrency(total)}</strong></td>
                                    <td colspan="2"></td>
                                </tr>`;
                            } else if (records.length === 0 || total === 0) {
                                tbody.innerHTML = `<tr>
                                    <td colspan="5" style="text-align: center; color: var(--text-sub); padding: 40px;">
                                        <i class="fa-solid fa-inbox" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                                        <p>Nenhum registro encontrado para ${window.selectedDate.month.toString().padStart(2, '0')}/${window.selectedDate.year}</p>
                                    </td>
                                </tr>`;
                            }
                        });
                    } else {
                        const tbody = document.getElementById(tableId);
                        if (tbody) {
                            tbody.innerHTML = `<tr>
                                <td colspan="5" style="text-align: center; color: var(--expense-color); padding: 20px;">
                                    Erro ao carregar dados. Tente recarregar a p√°gina.
                                </td>
                            </tr>`;
                        }
                    }
                });
            }

            window.togglePasswordVisibility = () => {
                const password = document.getElementById('password');
                const icon = document.getElementById('togglePassword');
                // Toggle the type
                const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
                password.setAttribute('type', type);
                // Toggle the icon class
                icon.classList.toggle('fa-eye-slash');
                icon.classList.toggle('fa-eye');
            };

            window.toggleAuthMode = () => {
                window.isLoginMode = !window.isLoginMode;
                document.getElementById('authTitle').innerText = window.isLoginMode ? 'Entrar no Sistema' : 'Criar Conta';
                document.getElementById('mainAuthBtn').innerText = window.isLoginMode ? 'Entrar' : 'Cadastrar';
                document.getElementById('authFooter').innerHTML = window.isLoginMode ? 
                    'N√£o tem conta? <span onclick="toggleAuthMode()" style="color: var(--primary-color); cursor: pointer; font-weight: 600;">Criar conta</span>' : 
                    'J√° tem conta? <span onclick="toggleAuthMode()" style="color: var(--primary-color); cursor: pointer; font-weight: 600;">Entrar</span>';
            };

            window.handleAuth = async () => {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                if (!email || !password) {
                    alert("Preencha e-mail e senha!");
                    return;
                }
                
                try {
                    if (window.isLoginMode) {
                        await signInWithEmailAndPassword(window.firebaseAuth, email, password);
                    } else {
                        await createUserWithEmailAndPassword(window.firebaseAuth, email, password);
                    }
                } catch (e) { 
                    alert("Erro: " + e.message); 
                }
            };

            window.forgotPassword = async () => {
                const email = document.getElementById('email').value;
                if (!email) return alert("Insira o e-mail primeiro.");
                try { 
                    await sendPasswordResetEmail(window.firebaseAuth, email); 
                    alert("E-mail de recupera√ß√£o enviado!"); 
                } catch (e) { 
                    alert("Erro: " + e.message); 
                }
            };

            window.logoutUser = async () => {
                try {
                    await signOut(window.firebaseAuth);
                    window.location.reload();
                } catch (error) {
                    alert("Erro ao terminar a sess√£o: " + error.message);
                }
            };

            window.openDeleteConfirmation = function(type) {
                window.deleteDataType = type;
                const typeText = type === 'expenses' ? 'despesas' : type === 'income' ? 'ganhos' : 'contas a pagar';
                const monthNames = [
                    'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                ];
                const periodString = `${monthNames[window.selectedDate.month - 1]} de ${window.selectedDate.year}`;

                document.getElementById('deleteDataTypeDisplay').textContent = typeText;
                document.getElementById('deleteMonthDisplay').textContent = periodString;
                document.getElementById('confirmDeleteModal').classList.add('active');
            };

            window.closeDeleteConfirmation = function() {
                document.getElementById('confirmDeleteModal').classList.remove('active');
                document.getElementById('deleteConfirmPassword').value = '';
                window.deleteDataType = null;
            };

            window.handleConfirmDelete = async function() {
                const password = document.getElementById('deleteConfirmPassword').value;
                if (!password) {
                    alert("Por favor, insira a sua senha para confirmar.");
                    return;
                }
                if (!window.deleteDataType) {
                    console.error("Tipo de dados para exclus√£o n√£o definido.");
                    closeDeleteConfirmation();
                    return;
                }

                const user = window.firebaseAuth.currentUser;
                if (!user) {
                    alert("Sess√£o expirada. Por favor, fa√ßa login novamente.");
                    window.location.reload();
                    return;
                }

                try {
                    // Re-autenticar para seguran√ßa
                    const credential = EmailAuthProvider.credential(user.email, password);
                    await reauthenticateWithCredential(user, credential);
                    
                    // Se a re-autentica√ß√£o for bem-sucedida, prosseguir com a exclus√£o
                    const collectionName = window.deleteDataType; // 'expenses', 'income' ou 'payments'
                    const { month, year } = window.selectedDate;

                    // Buscar registros do m√™s/ano
                    const q = query(
                        collection(window.firebaseDb, `users/${user.uid}/${collectionName}`)
                    );
                    
                    const snapshot = await getDocs(q);
                    const recordsToDelete = [];
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const dateObj = new Date(data.date + 'T00:00:00-03:00');
                        const recordMonth = data.month || (dateObj.getUTCMonth() + 1);
                        const recordYear = data.year || dateObj.getUTCFullYear();
                        
                        if (recordMonth === month && recordYear === year) {
                            recordsToDelete.push(doc.ref);
                        }
                    });
                    
                    if (recordsToDelete.length === 0) {
                        let msg = '';
                        if (collectionName === 'expenses') msg = 'Nenhuma despesa encontrada para este per√≠odo.';
                        else if (collectionName === 'income') msg = 'Nenhum ganho encontrado para este per√≠odo.';
                        else if (collectionName === 'payments') msg = 'Nenhuma conta a pagar encontrada para este per√≠odo.';
                        
                        alert(msg);
                        closeDeleteConfirmation();
                        return;
                    }

                    const batch = writeBatch(window.firebaseDb);
                    recordsToDelete.forEach(ref => {
                        batch.delete(ref);
                    });

                    await batch.commit();

                    let successMsg = '';
                    if (collectionName === 'expenses') successMsg = `${recordsToDelete.length} despesa(s) foram apagadas com sucesso!`;
                    else if (collectionName === 'income') successMsg = `${recordsToDelete.length} ganho(s) foram apagados com sucesso!`;
                    else if (collectionName === 'payments') successMsg = `${recordsToDelete.length} conta(s) a pagar foram apagadas com sucesso!`;

                    alert(successMsg);
                    closeDeleteConfirmation();

                    // Atualizar a interface
                    loadStats();
                    loadModernCharts();
                    updateSmartAlert();

                } catch (error) {
                    console.error("Erro na exclus√£o em massa:", error);
                    if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                        alert("Senha incorreta. A exclus√£o foi cancelada.");
                    } else {
                        alert("Ocorreu um erro ao tentar apagar os dados. Tente novamente.");
                    }
                }
            };

            onAuthStateChanged(window.firebaseAuth, (user) => {
                const authScreen = document.getElementById('authScreen');
                if (!authScreen) return;
                
                authScreen.style.display = user ? 'none' : 'flex';
                
                if (user) {
                    document.getElementById('userName').textContent = user.email.split('@')[0];
                    initApp();
                } else {
                    if (window.expensesVsGoalsChart) {
                        window.expensesVsGoalsChart.destroy();
                        window.expensesVsGoalsChart = null;
                    }
                    if (window.expenseDoughnutChart) {
                        window.expenseDoughnutChart.destroy();
                        window.expenseDoughnutChart = null;
                    }
                    if (window.evolutionAreaChart) {
                        window.evolutionAreaChart.destroy();
                        window.evolutionAreaChart = null;
                    }
                    if (window.topCategoriesChart) {
                        window.topCategoriesChart.destroy();
                        window.topCategoriesChart = null;
                    }
                }
            });

            document.getElementById('menuToggleBtn').onclick = (e) => {
                e.stopPropagation();
                document.getElementById('sidebar').classList.toggle('expanded');
                document.getElementById('overlay').classList.toggle('active');
                closeNotifications();
            };

            document.querySelectorAll('.nav-link').forEach(link => {
                link.onclick = (e) => {
                    e.preventDefault();
                    
                    // Se o bot√£o de logout for clicado, n√£o muda a p√°gina
                    if (link.id === 'logoutBtn') {
                        logoutUser();
                        return;
                    }
                    
                    const page = link.getAttribute('data-page');
                    if (!page) return;
                    
                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                    document.getElementById(page).classList.add('active');
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    
                    closeSidebar();
                    closeNotifications();
                    
                    if (page === 'dashboard') {
                        loadStats();
                        loadModernCharts();
                        updateSmartAlert();
                    } else if (page === 'expenses' || page === 'income' || page === 'payments') {
                        // Recarrega as listas quando mudar para estas p√°ginas
                        setTimeout(() => {
                            if (page === 'expenses') sync("expenses", "expensesTable");
                            if (page === 'income') sync("income", "incomeTable");
                            if (page === 'payments') loadPayments();
                        }, 100);
                    }
                };
            });

            function initApp() {
                updateCurrentDateDisplay();
                initializeDateSelector();
                loadCategories();
                sync("expenses", "expensesTable");
                sync("income", "incomeTable");
                loadPayments();
                loadGoals();
                loadStats();
                loadModernCharts();
                updateSmartAlert();
                checkDuePaymentsNotifications();
                setInterval(checkDuePaymentsNotifications, 3600000);
                
                const expDate = document.getElementById('expDate');
                const incDate = document.getElementById('incDate');
                const payDueDate = document.getElementById('payDueDate');
                
                if (expDate) expDate.value = getCurrentDate();
                if (incDate) incDate.value = getCurrentDate();
                if (payDueDate) payDueDate.value = getCurrentDate();
            }

            document.addEventListener('click', function(e) {
                const sidebar = document.getElementById('sidebar');
                const menuToggle = document.getElementById('menuToggleBtn');
                const notificationBadge = document.getElementById('notificationBadge');
                const notificationModal = document.getElementById('notificationModal');
                const importModal = document.getElementById('importModal');
                
                if (sidebar && !sidebar.contains(e.target) && menuToggle && !menuToggle.contains(e.target) && !e.target.closest('.menu-toggle')) {
                    closeSidebar();
                }
                
                if (notificationModal && notificationBadge && !notificationModal.contains(e.target) && !notificationBadge.contains(e.target) && !e.target.closest('.notification-badge')) {
                    closeNotifications();
                }
                
                if (importModal && importModal.classList.contains('active') && !e.target.closest('.modal-content') && !e.target.closest('.modal-overlay')) {
                    closeImportModal();
                }
            });

            window.addEventListener('DOMContentLoaded', () => {
                if (window.firebaseAuth.currentUser) {
                    document.getElementById('authScreen').style.display = 'none';
                    initApp();
                } else {
                    setTimeout(() => {
                        if (window.firebaseAuth.currentUser) {
                            document.getElementById('authScreen').style.display = 'none';
                            initApp();
                        }
                    }, 3000);
                }
            });
            
            // Fun√ß√£o auxiliar para verificar pagamentos pendentes
            function checkDuePaymentsNotifications() {
                if (!window.firebaseAuth.currentUser) return;
                
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                
                // Verificar contas vencidas
                const paymentsRef = collection(window.firebaseDb, `users/${window.firebaseAuth.currentUser.uid}/payments`);
                const overdueQuery = query(
                    paymentsRef,
                    where("status", "==", "pending")
                );
                
                getDocs(overdueQuery).then(snapshot => {
                    window.notifications = [];
                    
                    snapshot.forEach(doc => {
                        const payment = doc.data();
                        if (payment.dueDate && payment.dueDate < todayStr) {
                            window.notifications.push({
                                title: "Conta Atrasada",
                                message: `${payment.item} de ${formatCurrency(payment.value)} venceu em ${new Date(payment.dueDate + 'T00:00:00-03:00').toLocaleDateString('pt-BR')}`
                            });
                        }
                    });
                    
                    updateNotificationBadge();
                }).catch(error => {
                    console.error("Erro ao verificar contas vencidas:", error);
                });
            }
        }
    </script>
</body>
</html>
